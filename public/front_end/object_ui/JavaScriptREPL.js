import*as SDK from"../sdk/sdk.js";import{RemoteObjectPreviewFormatter}from"./RemoteObjectPreviewFormatter.js";export class JavaScriptREPL{static wrapObjectLiteral(e){if(!/^\s*\{/.test(e)||!/\}\s*$/.test(e))return e;const t=(async()=>0).constructor;try{t("return "+e+";");const r="("+e+")";return t(r),r}catch(t){return e}}static preprocessExpression(e){return JavaScriptREPL.wrapObjectLiteral(e)}static async evaluateAndBuildPreview(e,t,r,i,n){const a=self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext),o=void 0!==self.ObjectUI.JavaScriptREPL._MaxLengthForEvaluation?self.ObjectUI.JavaScriptREPL._MaxLengthForEvaluation:MaxLengthForEvaluation,c=e.length>o;if(!e||!a||t&&c)return{preview:createDocumentFragment(),result:null};const s={expression:JavaScriptREPL.preprocessExpression(e),generatePreview:!0,includeCommandLineAPI:!0,throwOnSideEffect:t,timeout:r,objectGroup:n,disableBreaks:!0,replMode:!0},p=await a.evaluate(s,!1,!1);return{preview:JavaScriptREPL._buildEvaluationPreview(p,i),result:p}}static _buildEvaluationPreview(e,t){const r=createDocumentFragment();if(e.error)return r;if(e.exceptionDetails&&e.exceptionDetails.exception&&e.exceptionDetails.exception.description){const i=e.exceptionDetails.exception.description;return(i.startsWith("TypeError: ")||t)&&(r.createChild("span").textContent=e.exceptionDetails.text+" "+i),r}const i=new RemoteObjectPreviewFormatter,{preview:n,type:a,subtype:o,description:c}=e.object;if(n&&"object"===a&&"node"!==o)i.appendObjectPreview(r,n,!1);else{const e=i.renderPropertyPreview(a,o,c.trimEndWithMaxLength(400));r.appendChild(e)}return r}}export const MaxLengthForEvaluation=2e3;