import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class WarningErrorCounter{constructor(){WarningErrorCounter._instanceForTest=this;const e=createElement("div");this._toolbarItem=new UI.Toolbar.ToolbarItem(e),this._counter=createElement("div"),this._counter.addEventListener("click",Common.Console.Console.instance().show.bind(Common.Console.Console.instance()),!1);const t=UI.Utils.createShadowRootWithCoreStyles(this._counter,"console_counters/errorWarningCounter.css");e.appendChild(this._counter),this._violationCounter=createElement("div"),this._violationCounter.addEventListener("click",()=>{UI.ViewManager.ViewManager.instance().showView("lighthouse")});const s=UI.Utils.createShadowRootWithCoreStyles(this._violationCounter,"console_counters/errorWarningCounter.css");Root.Runtime.experiments.isEnabled("spotlight")&&e.appendChild(this._violationCounter),this._issuesCounter=createElement("div"),this._issuesCounter.addEventListener("click",()=>{UI.ViewManager.ViewManager.instance().showView("issues-pane")});const i=UI.Utils.createShadowRootWithCoreStyles(this._issuesCounter,"console_counters/errorWarningCounter.css");Root.Runtime.experiments.isEnabled("issuesPane")&&e.appendChild(this._issuesCounter),this._errors=this._createItem(t,"smallicon-error"),this._warnings=this._createItem(t,"smallicon-warning"),Root.Runtime.experiments.isEnabled("spotlight")&&(this._violations=this._createItem(s,"smallicon-info")),Root.Runtime.experiments.isEnabled("issuesPane")&&(this._issues=this._createItem(i,"smallicon-issue-blue-text")),this._titles="",this._errorCount=-1,this._warningCount=-1,this._violationCount=-1,this._issuesCount=-1,this._throttler=new Common.Throttler.Throttler(100),SDK.ConsoleModel.ConsoleModel.instance().addEventListener(SDK.ConsoleModel.Events.ConsoleCleared,this._update,this),SDK.ConsoleModel.ConsoleModel.instance().addEventListener(SDK.ConsoleModel.Events.MessageAdded,this._update,this),SDK.ConsoleModel.ConsoleModel.instance().addEventListener(SDK.ConsoleModel.Events.MessageUpdated,this._update,this),this._issuesModel=null,SDK.SDKModel.TargetManager.instance().observeTargets(this),this._update()}_updatedForTest(){}targetAdded(e){if(this._issuesModel)return;const t=SDK.SDKModel.TargetManager.instance().mainTarget();t&&(this._issuesModel=t.model(SDK.IssuesModel.IssuesModel),this._issuesModel&&this._issuesModel.addEventListener(SDK.IssuesModel.Events.IssuesCountUpdated,this._update,this)),this._update()}targetRemoved(e){}_createItem(e,t){const s=createElementWithClass("span","counter-item");UI.ARIAUtils.markAsHidden(s);const i=s.createChild("span","","dt-icon-label");i.type=t;const o=i.createChild("span");return e.appendChild(s),{item:s,text:o}}_updateItem(e,t,s){e.item.classList.toggle("hidden",!t),e.item.classList.toggle("counter-item-first",s),e.text.textContent=t}_update(){this._updatingForTest=!0,this._throttler.schedule(this._updateThrottled.bind(this))}_updateThrottled(){const e=SDK.ConsoleModel.ConsoleModel.instance().errors(),t=SDK.ConsoleModel.ConsoleModel.instance().warnings(),s=SDK.ConsoleModel.ConsoleModel.instance().violations(),i=this._issuesModel&&this._issuesModel.numberOfAggregatedIssues()||0;if(e===this._errorCount&&t===this._warningCount&&s===this._violationCount&&i===this._issuesCount)return Promise.resolve();this._errorCount=e,this._warningCount=t,this._violationCount=s,this._issuesCount=i,this._counter.classList.toggle("hidden",!(e||t)),this._violationCounter.classList.toggle("hidden",!s),this._toolbarItem.setVisible(!!(e||t||s));let o="";o=1===e?ls`${e} error`:ls`${e} errors`,this._updateItem(this._errors,e,!1);let n="";if(n=1===t?ls`${t} warning`:ls`${t} warnings`,this._updateItem(this._warnings,t,!e),Root.Runtime.experiments.isEnabled("spotlight")){let e="";e=1===s?ls`${s} violation`:ls`${s} violations`,this._updateItem(this._violations,s,!0),this._violationCounter.title=e}if(Root.Runtime.experiments.isEnabled("issuesPane")){let e="";e=1===i?ls`${i} issue`:ls`${i} issues`,this._updateItem(this._issues,i,!0),this._issuesCounter.title=e}return this._titles="",e&t?this._titles=ls`${o}, ${n}`:e?this._titles=o:t&&(this._titles=n),this._counter.title=this._titles,UI.ARIAUtils.setAccessibleName(this._counter,this._titles),self.UI.inspectorView.toolbarItemResized(),this._updatingForTest=!1,this._updatedForTest(),Promise.resolve()}item(){return this._toolbarItem}}