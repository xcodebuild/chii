import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{StorageItemsView}from"./StorageItemsView.js";export class CookieItemsView extends StorageItemsView{constructor(e,t){super(Common.UIString.UIString("Cookies"),"cookiesPanel"),this.registerRequiredCSS("resources/cookieItemsView.css"),this.element.classList.add("storage-view"),this._model=e,this._cookieDomain=t,this._totalSize=0,this._cookiesTable=this._cookiesTable=new CookieTable.CookiesTable(!1,this._saveCookie.bind(this),this.refreshItems.bind(this),this._handleCookieSelected.bind(this),this._deleteCookie.bind(this)),this._cookiesTable.setMinimumSize(0,50),this._splitWidget=new UI.SplitWidget.SplitWidget(!1,!0,"cookieItemsSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new UI.Widget.VBox;const i=this._previewPanel.element.createChild("div","preview-panel-resizer");this._splitWidget.setMainWidget(this._cookiesTable),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(i),this._onlyIssuesFilterUI=new UI.Toolbar.ToolbarCheckbox(ls`Only blocked`,ls`Only show blocked Cookies`,()=>{this._updateWithCookies(this._allCookies)}),this.appendToolbarItem(this._onlyIssuesFilterUI),this._refreshThrottler=new Common.Throttler.Throttler(300),this._eventDescriptors=[],this._preview=null,this._previewValue=null,this._allCookies=[],this.setCookiesDomain(e,t)}setCookiesDomain(e,t){this._model=e,this._cookieDomain=t,this.refreshItems(),Common.EventTarget.EventTarget.removeEventListeners(this._eventDescriptors);const i=e.target().model(SDK.NetworkManager.NetworkManager);this._eventDescriptors=[i.addEventListener(SDK.NetworkManager.Events.ResponseReceived,this._onResponseReceived,this),i.addEventListener(SDK.NetworkManager.Events.LoadingFinished,this._onLoadingFinished,this)],this._showPreview(null,null)}_showPreview(e,t){this._preview&&this._previewValue===t||(this._preview&&this._preview.detach(),e||(e=new UI.EmptyWidget.EmptyWidget(ls`Select a cookie to preview its value`)),this._previewValue=t,this._preview=e,e.show(this._previewPanel.contentElement))}_handleCookieSelected(){const e=this._cookiesTable.selectedCookie();if(this.setCanDeleteSelected(!!e),!e)return void this._showPreview(null,null);const t=createElementWithClass("div","cookie-value");t.textContent=e.value(),t.addEventListener("dblclick",(function(){const e=document.createRange();e.selectNode(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(e)}));const i=new UI.Widget.VBox;i.contentElement.appendChild(t),this._showPreview(i,e)}_saveCookie(e,t){return this._model?(t&&e.key()!==t.key()&&this._model.deleteCookie(t),this._model.saveCookie(e)):Promise.resolve(!1)}_deleteCookie(e,t){this._model.deleteCookie(e,t)}_updateWithCookies(e){this._allCookies=e,this._totalSize=e.reduce((e,t)=>e+t.size(),0);const t=Common.ParsedURL.ParsedURL.fromString(this._cookieDomain),i=t?t.host:"";this._cookiesTable.setCookieDomain(i);const s=this.filter(e,e=>`${e.name()} ${e.value()} ${e.domain()}`);this._cookiesTable.setCookies(s,this._model.getCookieToBlockedReasonsMap()),this.setCanFilter(!0),this.setCanDeleteAll(!0),this.setCanDeleteSelected(!!this._cookiesTable.selectedCookie())}filter(e,t){return super.filter(e,t).filter(e=>!this._onlyIssuesFilterUI.checked()||SDK.RelatedIssue.hasIssues(e))}deleteAllItems(){this._model.clear(this._cookieDomain,()=>this.refreshItems())}deleteSelectedItem(){const e=this._cookiesTable.selectedCookie();e&&this._model.deleteCookie(e,()=>this.refreshItems())}refreshItems(){this._model.getCookiesForDomain(this._cookieDomain).then(this._updateWithCookies.bind(this))}refreshItemsThrottled(){this._refreshThrottler.schedule(()=>Promise.resolve(this.refreshItems()))}_onResponseReceived(){this.refreshItemsThrottled()}_onLoadingFinished(){this.refreshItemsThrottled()}}