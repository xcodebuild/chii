import*as Common from"../common/common.js";import*as ProtocolClient from"../protocol_client/protocol_client.js";import{DOMModel}from"./DOMModel.js";import{Events as NetworkManagerEvents,NetworkManager}from"./NetworkManager.js";import{NetworkRequest}from"./NetworkRequest.js";import{Resource}from"./Resource.js";import{ExecutionContext,RuntimeModel}from"./RuntimeModel.js";import{Capability,SDKModel,Target,TargetManager}from"./SDKModel.js";import{SecurityOriginManager}from"./SecurityOriginManager.js";export class ResourceTreeModel extends SDKModel{constructor(e){super(e);const r=e.model(NetworkManager);r&&(r.addEventListener(NetworkManagerEvents.RequestFinished,this._onRequestFinished,this),r.addEventListener(NetworkManagerEvents.RequestUpdateDropped,this._onRequestUpdateDropped,this)),this._agent=e.pageAgent(),this._agent.enable(),this._securityOriginManager=e.model(SecurityOriginManager),e.registerPageDispatcher(new PageDispatcher(this)),this._frames=new Map,this._cachedResourcesProcessed=!1,this._pendingReloadOptions=null,this._reloadSuspensionCount=0,this._isInterstitialShowing=!1,this.mainFrame=null,this._agent.getResourceTree().then(this._processCachedResources.bind(this))}static frameForRequest(e){const r=NetworkManager.forRequest(e),t=r?r.target().model(ResourceTreeModel):null;return t?t.frameForId(e.frameId):null}static frames(){const e=[];for(const r of TargetManager.instance().models(ResourceTreeModel))e.push(...r._frames.values());return e}static resourceForURL(e){for(const r of TargetManager.instance().models(ResourceTreeModel)){const t=r.mainFrame,s=t?t.resourceForURL(e):null;if(s)return s}return null}static reloadAllPages(e,r){for(const t of TargetManager.instance().models(ResourceTreeModel))t.target().parentTarget()||t.reloadPage(e,r)}domModel(){return this.target().model(DOMModel)}_processCachedResources(e){e&&(this.dispatchEventToListeners(Events.WillLoadCachedResources),this._addFramesRecursively(null,e),this.target().setInspectedURL(e.frame.url)),this._cachedResourcesProcessed=!0;const r=this.target().model(RuntimeModel);r&&(r.setExecutionContextComparator(this._executionContextComparator.bind(this)),r.fireExecutionContextOrderChanged()),this.dispatchEventToListeners(Events.CachedResourcesLoaded,this)}cachedResourcesLoaded(){return this._cachedResourcesProcessed}isInterstitialShowing(){return this._isInterstitialShowing}_addFrame(e,r){this._frames.set(e.id,e),e.isMainFrame()&&(this.mainFrame=e),this.dispatchEventToListeners(Events.FrameAdded,e),this._updateSecurityOrigins()}_frameAttached(e,r,t){const s=r&&this._frames.get(r)||null;if(!this._cachedResourcesProcessed&&s)return null;if(this._frames.has(e))return null;const a=new ResourceTreeFrame(this,s,e,null,t||null);return r&&!s&&(a._crossTargetParentFrameId=r),a.isMainFrame()&&this.mainFrame&&this._frameDetached(this.mainFrame.id),this._addFrame(a,!0),a}_frameNavigated(e){const r=e.parentId&&this._frames.get(e.parentId)||null;if(!this._cachedResourcesProcessed&&r)return;let t=this._frames.get(e.id);t||(t=this._frameAttached(e.id,e.parentId||""),console.assert(t)),this.dispatchEventToListeners(Events.FrameWillNavigate,t),t._navigate(e),this.dispatchEventToListeners(Events.FrameNavigated,t),t.isMainFrame()&&this.dispatchEventToListeners(Events.MainFrameNavigated,t);const s=t.resources();for(let e=0;e<s.length;++e)this.dispatchEventToListeners(Events.ResourceAdded,s[e]);t.isMainFrame()&&this.target().setInspectedURL(t.url),this._updateSecurityOrigins()}_frameDetached(e){if(!this._cachedResourcesProcessed)return;const r=this._frames.get(e);r&&(r.parentFrame?r.parentFrame._removeChildFrame(r):r._remove(),this._updateSecurityOrigins())}_onRequestFinished(e){if(!this._cachedResourcesProcessed)return;const r=e.data;if(r.failed||r.resourceType()===Common.ResourceType.resourceTypes.XHR)return;const t=this._frames.get(r.frameId);t&&t._addRequest(r)}_onRequestUpdateDropped(e){if(!this._cachedResourcesProcessed)return;const r=e.data.frameId,t=this._frames.get(r);if(!t)return;const s=e.data.url;if(t._resourcesMap[s])return;const a=new Resource(this,null,s,t.url,r,e.data.loaderId,Common.ResourceType.resourceTypes[e.data.resourceType],e.data.mimeType,e.data.lastModified,null);t.addResource(a)}frameForId(e){return this._frames.get(e)}forAllResources(e){return!!this.mainFrame&&this.mainFrame._callForFrameResources(e)}frames(){return[...this._frames.values()]}resourceForURL(e){return this.mainFrame?this.mainFrame.resourceForURL(e):null}_addFramesRecursively(e,r){const t=r.frame,s=new ResourceTreeFrame(this,e,t.id,t,null);!e&&t.parentId&&(s._crossTargetParentFrameId=t.parentId),this._addFrame(s);for(const e of r.childFrames||[])this._addFramesRecursively(s,e);for(let e=0;e<r.resources.length;++e){const a=r.resources[e],i=this._createResourceFromFramePayload(t,a.url,Common.ResourceType.resourceTypes[a.type],a.mimeType,a.lastModified||null,a.contentSize||null);s.addResource(i)}if(!s._resourcesMap[t.url]){const e=this._createResourceFromFramePayload(t,t.url,Common.ResourceType.resourceTypes.Document,t.mimeType,null,null);s.addResource(e)}}_createResourceFromFramePayload(e,r,t,s,a,i){const n="number"==typeof a?new Date(1e3*a):null;return new Resource(this,null,r,e.url,e.id,e.loaderId,t,s,n,i)}suspendReload(){this._reloadSuspensionCount++}resumeReload(){this._reloadSuspensionCount--,console.assert(this._reloadSuspensionCount>=0,"Unbalanced call to ResourceTreeModel.resumeReload()"),!this._reloadSuspensionCount&&this._pendingReloadOptions&&this.reloadPage.apply(this,this._pendingReloadOptions)}reloadPage(e,r){this._pendingReloadOptions||this.dispatchEventToListeners(Events.PageReloadRequested,this),this._reloadSuspensionCount?this._pendingReloadOptions=[e,r]:(this._pendingReloadOptions=null,this.dispatchEventToListeners(Events.WillReloadPage),this._agent.reload(e,r))}navigate(e){return this._agent.navigate(e)}async navigationHistory(){const e=await this._agent.invoke_getNavigationHistory({});return e[ProtocolClient.InspectorBackend.ProtocolError]?null:{currentIndex:e.currentIndex,entries:e.entries}}navigateToHistoryEntry(e){this._agent.navigateToHistoryEntry(e.id)}async fetchAppManifest(){const e=await this._agent.invoke_getAppManifest({});return e[ProtocolClient.InspectorBackend.ProtocolError]?{url:e.url,data:null,errors:[]}:{url:e.url,data:e.data||null,errors:e.errors}}async getInstallabilityErrors(){return(await this._agent.invoke_getInstallabilityErrors({})).installabilityErrors||[]}async getManifestIcons(){return{primaryIcon:(await this._agent.invoke_getManifestIcons({})).primaryIcon||null}}_executionContextComparator(e,r){function t(e){let r=e;const t=[];for(;r;)t.push(r),r=r.parentFrame;return t.reverse()}if(e.target()!==r.target())return ExecutionContext.comparator(e,r);const s=e.frameId?t(this.frameForId(e.frameId)):[],a=r.frameId?t(this.frameForId(r.frameId)):[];let i,n;for(let e=0;;e++)if(!s[e]||!a[e]||s[e]!==a[e]){i=s[e],n=a[e];break}return!i&&n?-1:!n&&i?1:i&&n?i.id.localeCompare(n.id):ExecutionContext.comparator(e,r)}_getSecurityOriginData(){const e=new Set;let r=null,t=null;for(const s of this._frames.values()){const a=s.securityOrigin;if(a&&(e.add(a),s.isMainFrame()&&(r=a,s.unreachableUrl()))){t=new Common.ParsedURL.ParsedURL(s.unreachableUrl()).securityOrigin()}}return{securityOrigins:e,mainSecurityOrigin:r,unreachableMainSecurityOrigin:t}}_updateSecurityOrigins(){const e=this._getSecurityOriginData();this._securityOriginManager.setMainSecurityOrigin(e.mainSecurityOrigin||"",e.unreachableMainSecurityOrigin||""),this._securityOriginManager.updateSecurityOrigins(e.securityOrigins)}getMainSecurityOrigin(){const e=this._getSecurityOriginData();return e.mainSecurityOrigin||e.unreachableMainSecurityOrigin}}export const Events={FrameAdded:Symbol("FrameAdded"),FrameNavigated:Symbol("FrameNavigated"),FrameDetached:Symbol("FrameDetached"),FrameResized:Symbol("FrameResized"),FrameWillNavigate:Symbol("FrameWillNavigate"),MainFrameNavigated:Symbol("MainFrameNavigated"),ResourceAdded:Symbol("ResourceAdded"),WillLoadCachedResources:Symbol("WillLoadCachedResources"),CachedResourcesLoaded:Symbol("CachedResourcesLoaded"),DOMContentLoaded:Symbol("DOMContentLoaded"),LifecycleEvent:Symbol("LifecycleEvent"),Load:Symbol("Load"),PageReloadRequested:Symbol("PageReloadRequested"),WillReloadPage:Symbol("WillReloadPage"),InterstitialShown:Symbol("InterstitialShown"),InterstitialHidden:Symbol("InterstitialHidden")};export class ResourceTreeFrame{constructor(e,r,t,s,a){this._model=e,this._parentFrame=r,this._id=t,this._url="",this._crossTargetParentFrameId=null,s&&(this._loaderId=s.loaderId,this._name=s.name,this._url=s.url,this._securityOrigin=s.securityOrigin,this._mimeType=s.mimeType,this._unreachableUrl=s.unreachableUrl||""),this._creationStackTrace=a,this._childFrames=new Set,this._resourcesMap={},this._parentFrame&&this._parentFrame._childFrames.add(this)}_navigate(e){this._loaderId=e.loaderId,this._name=e.name,this._url=e.url,this._securityOrigin=e.securityOrigin,this._mimeType=e.mimeType,this._unreachableUrl=e.unreachableUrl||"";const r=this._resourcesMap[this._url];this._resourcesMap={},this._removeChildFrames(),r&&r.loaderId===this._loaderId&&this.addResource(r)}resourceTreeModel(){return this._model}get id(){return this._id}get name(){return this._name||""}get url(){return this._url}get securityOrigin(){return this._securityOrigin}unreachableUrl(){return this._unreachableUrl}get loaderId(){return this._loaderId}get parentFrame(){return this._parentFrame}get childFrames(){return[...this._childFrames]}crossTargetParentFrame(){if(!this._crossTargetParentFrameId)return null;if(!this._model.target().parentTarget())return null;const e=this._model.target().parentTarget().model(ResourceTreeModel);return e&&e._frames.get(this._crossTargetParentFrameId)||null}findCreationCallFrame(e){let r=this._creationStackTrace;for(;r;){const t=r.callFrames.find(e);if(t)return t;r=this.parent}return null}isMainFrame(){return!this._parentFrame}isTopFrame(){return!this._parentFrame&&!this._crossTargetParentFrameId}get mainResource(){return this._resourcesMap[this._url]}_removeChildFrame(e){this._childFrames.delete(e),e._remove()}_removeChildFrames(){const e=this._childFrames;this._childFrames=new Set;for(const r of e)r._remove()}_remove(){this._removeChildFrames(),this._model._frames.delete(this.id),this._model.dispatchEventToListeners(Events.FrameDetached,this)}addResource(e){this._resourcesMap[e.url]!==e&&(this._resourcesMap[e.url]=e,this._model.dispatchEventToListeners(Events.ResourceAdded,e))}_addRequest(e){let r=this._resourcesMap[e.url()];r&&r.request===e||(r=new Resource(this._model,e,e.url(),e.documentURL,e.frameId,e.loaderId,e.resourceType(),e.mimeType,null,null),this._resourcesMap[r.url]=r,this._model.dispatchEventToListeners(Events.ResourceAdded,r))}resources(){const e=[];for(const r in this._resourcesMap)e.push(this._resourcesMap[r]);return e}resourceForURL(e){const r=this._resourcesMap[e];if(r)return r;for(const r of this._childFrames){const t=r.resourceForURL(e);if(t)return t}return null}_callForFrameResources(e){for(const r in this._resourcesMap)if(e(this._resourcesMap[r]))return!0;for(const r of this._childFrames)if(r._callForFrameResources(e))return!0;return!1}displayName(){if(this.isTopFrame())return Common.UIString.UIString("top");const e=new Common.ParsedURL.ParsedURL(this._url).displayName;return e?this._name?this._name+" ("+e+")":e:Common.UIString.UIString("<iframe>")}}export class PageDispatcher{constructor(e){this._resourceTreeModel=e}domContentEventFired(e){this._resourceTreeModel.dispatchEventToListeners(Events.DOMContentLoaded,e)}loadEventFired(e){this._resourceTreeModel.dispatchEventToListeners(Events.Load,{resourceTreeModel:this._resourceTreeModel,loadTime:e})}lifecycleEvent(e,r,t,s){this._resourceTreeModel.dispatchEventToListeners(Events.LifecycleEvent,{frameId:e,name:t})}frameAttached(e,r,t){this._resourceTreeModel._frameAttached(e,r,t)}frameNavigated(e){this._resourceTreeModel._frameNavigated(e)}frameDetached(e){this._resourceTreeModel._frameDetached(e)}frameStartedLoading(e){}frameStoppedLoading(e){}frameRequestedNavigation(e){}frameScheduledNavigation(e,r){}frameClearedScheduledNavigation(e){}navigatedWithinDocument(e,r){}frameResized(){this._resourceTreeModel.dispatchEventToListeners(Events.FrameResized,null)}javascriptDialogOpening(e,r,t,s,a){s||this._resourceTreeModel._agent.handleJavaScriptDialog(!1)}javascriptDialogClosed(e,r){}screencastFrame(e,r,t){}screencastVisibilityChanged(e){}interstitialShown(){this._resourceTreeModel._isInterstitialShowing=!0,this._resourceTreeModel.dispatchEventToListeners(Events.InterstitialShown)}interstitialHidden(){this._resourceTreeModel._isInterstitialShowing=!1,this._resourceTreeModel.dispatchEventToListeners(Events.InterstitialHidden)}windowOpen(e,r,t,s){}compilationCacheProduced(e,r){}fileChooserOpened(e){}downloadWillBegin(e,r){}downloadProgress(){}}SDKModel.register(ResourceTreeModel,Capability.DOM,!0);export let SecurityOriginData;