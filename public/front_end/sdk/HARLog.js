import*as Common from"../common/common.js";import{Cookie}from"./Cookie.js";import{PageLoad}from"./NetworkLog.js";import{NetworkRequest}from"./NetworkRequest.js";export class HARLog{static pseudoWallTime(e,t){return new Date(1e3*e.pseudoWallTime(t))}static async build(e){const t=new HARLog,s=[];for(const t of e)s.push(Entry.build(t));const r=await Promise.all(s);return{version:"1.2",creator:t._creator(),pages:t._buildPages(e),entries:r}}_creator(){const e=/AppleWebKit\/([^ ]+)/.exec(window.navigator.userAgent);return{name:"WebInspector",version:e?e[1]:"n/a"}}_buildPages(e){const t={},s=[];for(let r=0;r<e.length;++r){const o=e[r],i=PageLoad.forRequest(o);i&&!t[i.id]&&(t[i.id]=!0,s.push(this._convertPage(i,o)))}return s}_convertPage(e,t){return{startedDateTime:HARLog.pseudoWallTime(t,e.startTime).toJSON(),id:"page_"+e.id,title:e.url,pageTimings:{onContentLoad:this._pageEventTime(e,e.contentLoadTime),onLoad:this._pageEventTime(e,e.loadTime)}}}_pageEventTime(e,t){const s=e.startTime;return-1===t||-1===s?-1:Entry._toMilliseconds(t-s)}}export class Entry{constructor(e){this._request=e}static _toMilliseconds(e){return-1===e?-1:1e3*e}static async build(e){const t=new Entry(e);let s=t._request.remoteAddress();const r=s.lastIndexOf(":");-1!==r&&(s=s.substr(0,r));const o=t._buildTimings();let i=0;for(const e of[o.blocked,o.dns,o.connect,o.send,o.wait,o.receive])i+=Math.max(e,0);const n=t._request.initiator(),u={};u.type=n.type,void 0!==n.url&&(u.url=n.url),void 0!==n.lineNumber&&(u.lineNumber=n.lineNumber),n.stack&&(u.stack=n.stack);const a={startedDateTime:HARLog.pseudoWallTime(t._request,t._request.issueTime()).toJSON(),time:i,request:await t._buildRequest(),response:t._buildResponse(),cache:{},timings:o,serverIPAddress:s.replace(/\[\]/g,""),_initiator:u,_priority:t._request.priority(),_resourceType:t._request.resourceType().name()};t._request.cached()&&(a._fromCache=t._request.cachedInMemory()?"memory":"disk"),"0"!==t._request.connectionId&&(a.connection=t._request.connectionId);const d=PageLoad.forRequest(t._request);if(d&&(a.pageref="page_"+d.id),t._request.resourceType()===Common.ResourceType.resourceTypes.WebSocket){const e=[];for(const s of t._request.frames())e.push({type:s.type,time:s.time,opcode:s.opCode,data:s.text});a._webSocketMessages=e}return a}async _buildRequest(){const e=this._request.requestHeadersText(),t={method:this._request.requestMethod,url:this._buildRequestURL(this._request.url()),httpVersion:this._request.requestHttpVersion(),headers:this._request.requestHeaders(),queryString:this._buildParameters(this._request.queryParameters||[]),cookies:this._buildCookies(this._request.requestCookies),headersSize:e?e.length:-1,bodySize:await this._requestBodySize()},s=await this._buildPostData();return s&&(t.postData=s),t}_buildResponse(){const e=this._request.responseHeadersText;return{status:this._request.statusCode,statusText:this._request.statusText,httpVersion:this._request.responseHttpVersion(),headers:this._request.responseHeaders,cookies:this._buildCookies(this._request.responseCookies),content:this._buildContent(),redirectURL:this._request.responseHeaderValue("Location")||"",headersSize:e?e.length:-1,bodySize:this.responseBodySize,_transferSize:this._request.transferSize,_error:this._request.localizedFailDescription}}_buildContent(){const e={size:this._request.resourceSize,mimeType:this._request.mimeType||"x-unknown"},t=this.responseCompression;return"number"==typeof t&&(e.compression=t),e}_buildTimings(){const e=this._request.timing,t=this._request.issueTime(),s=this._request.startTime,r={blocked:-1,dns:-1,ssl:-1,connect:-1,send:0,wait:0,receive:0,_blocked_queueing:-1},o=t<s?s-t:-1;r.blocked=Entry._toMilliseconds(o),r._blocked_queueing=Entry._toMilliseconds(o);let i=0;if(e){const t=_([e.dnsStart,e.connectStart,e.sendStart]);t!==1/0&&(r.blocked+=t),-1!==e.proxyEnd&&(r._blocked_proxy=e.proxyEnd-e.proxyStart),r._blocked_proxy&&r._blocked_proxy>r.blocked&&(r.blocked=r._blocked_proxy);const s=e.dnsEnd>=0?t:0,o=e.dnsEnd>=0?e.dnsEnd:-1;r.dns=o-s;const n=e.sslEnd>0?e.sslStart:0,u=e.sslEnd>0?e.sslEnd:-1;r.ssl=u-n;const a=e.connectEnd>=0?_([o,t]):0,d=e.connectEnd>=0?e.connectEnd:-1;r.connect=d-a;const c=e.sendEnd>=0?Math.max(d,o,t):0,l=e.sendEnd>=0?e.sendEnd:0;r.send=l-c,r.send<0&&(r.send=0),i=Math.max(l,d,u,o,t,0)}else if(-1===this._request.responseReceivedTime)return r.blocked=this._request.endTime-t,r;const n=e?e.requestTime:s,u=i,a=Entry._toMilliseconds(this._request.responseReceivedTime-n);r.wait=a-u;const d=a,c=Entry._toMilliseconds(this._request.endTime-n);return r.receive=Math.max(c-d,0),r;function _(e){return e.reduce((e,t)=>t>=0&&t<e?t:e,1/0)}}async _buildPostData(){const e=await this._request.requestFormData();if(!e)return null;const t={mimeType:this._request.requestContentType()||"",text:e},s=await this._request.formParameters();return s&&(t.params=this._buildParameters(s)),t}_buildParameters(e){return e.slice()}_buildRequestURL(e){return e.split("#",2)[0]}_buildCookies(e){return e.map(this._buildCookie.bind(this))}_buildCookie(e){const t={name:e.name(),value:e.value(),path:e.path(),domain:e.domain(),expires:e.expiresDate(HARLog.pseudoWallTime(this._request,this._request.startTime)),httpOnly:e.httpOnly(),secure:e.secure()};return e.sameSite()&&(t.sameSite=e.sameSite()),t}async _requestBodySize(){const e=await this._request.requestFormData();return e?new TextEncoder("utf-8").encode(e).length:0}get responseBodySize(){return this._request.cached()||304===this._request.statusCode?0:this._request.responseHeadersText?this._request.transferSize-this._request.responseHeadersText.length:-1}get responseCompression(){if(!this._request.cached()&&304!==this._request.statusCode&&206!==this._request.statusCode&&this._request.responseHeadersText)return this._request.resourceSize-this.responseBodySize}}export let Timing;