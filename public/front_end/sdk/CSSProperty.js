import*as Common from"../common/common.js";import*as HostModule from"../host/host.js";import*as Platform from"../platform/platform.js";import{cssMetadata,GridAreaRowRegex}from"./CSSMetadata.js";import{Edit}from"./CSSModel.js";import{CSSStyleDeclaration}from"./CSSStyleDeclaration.js";export class CSSProperty{constructor(t,e,s,n,i,r,a,o,l,h){this.ownerStyle=t,this.index=e,this.name=s,this.value=n,this.important=i,this.disabled=r,this.parsedOk=a,this.implicit=o,this.text=l,this.range=h?TextUtils.TextRange.fromObject(h):null,this._active=!0,this._nameRange=null,this._valueRange=null}static parsePayload(t,e,s){return new CSSProperty(t,e,s.name,s.value,s.important||!1,s.disabled||!1,!("parsedOk"in s)||!!s.parsedOk,!!s.implicit,s.text,s.range)}_ensureRanges(){if(this._nameRange&&this._valueRange)return;const t=this.range,e=this.text?new TextUtils.Text(this.text):null;if(!t||!e)return;const s=e.value().indexOf(this.name),n=e.value().lastIndexOf(this.value);if(-1===s||-1===n||s>n)return;const i=new TextUtils.SourceRange(s,this.name.length),r=new TextUtils.SourceRange(n,this.value.length);function a(t,e,s){return 0===t.startLine&&(t.startColumn+=s,t.endColumn+=s),t.startLine+=e,t.endLine+=e,t}this._nameRange=a(e.toTextRange(i),t.startLine,t.startColumn),this._valueRange=a(e.toTextRange(r),t.startLine,t.startColumn)}nameRange(){return this._ensureRanges(),this._nameRange}valueRange(){return this._ensureRanges(),this._valueRange}rebase(t){this.ownerStyle.styleSheetId===t.styleSheetId&&this.range&&(this.range=this.range.rebaseAfterTextEdit(t.oldRange,t.newRange))}setActive(t){this._active=t}get propertyText(){return void 0!==this.text?this.text:""===this.name?"":this.name+": "+this.value+(this.important?" !important":"")+";"}activeInStyle(){return this._active}async setText(t,e,s){if(!this.ownerStyle)return Promise.reject(new Error("No ownerStyle for property"));if(!this.ownerStyle.styleSheetId)return Promise.reject(new Error("No owner style id"));if(!this.range||!this.ownerStyle.range)return Promise.reject(new Error("Style not editable"));if(e&&HostModule.userMetrics.actionTaken(Host.UserMetrics.Action.StyleRuleEdited),s&&t===this.propertyText)return this.ownerStyle.cssModel().domModel().markUndoableState(!e),Promise.resolve(!0);const n=this.range.relativeTo(this.ownerStyle.range.startLine,this.ownerStyle.range.startColumn),i=this.ownerStyle.cssText?this._detectIndentation(this.ownerStyle.cssText):Common.Settings.Settings.instance().moduleSetting("textEditorIndent").get(),r=this.ownerStyle.cssText?i.substring(0,this.ownerStyle.range.endColumn):"",a=new TextUtils.Text(this.ownerStyle.cssText||"").replaceRange(n,Platform.StringUtilities.sprintf(";%s;",t)),o=await self.runtime.extension(TextUtils.TokenizerFactory).instance(),l=CSSProperty._formatStyle(a,i,r,o);return this.ownerStyle.setText(l,e)}static _formatStyle(t,e,s,n){const i=e.substring(s.length)+e;e&&(e="\n"+e);let r,a="",o="",l=!1,h=!1;return n.createTokenizer("text/css")("*{"+t+"}",(function(t,s,n,m){if(!l){const n=s&&s.includes("css-comment")&&function(t){const e=t.indexOf(":");if(-1===e)return!1;const s=t.substring(2,e).trim();return cssMetadata().isCSSPropertyName(s)}(t),i=s&&(s.includes("css-string")||s.includes("css-meta")||s.includes("css-property")||s.includes("css-variable-2"));return n?a=a.trimRight()+e+t:i?(l=!0,r=t):(";"!==t||h)&&(a+=t,!t.trim()||s&&s.includes("css-comment")||(h=";"!==t)),void("{"!==t||s||(h=!1))}if("}"===t||";"===t)a=a.trimRight()+e+r.trim()+";",h=!1,l=!1,o="","}"===t&&(a+="}");else{if(cssMetadata().isGridAreaDefiningProperty(o)){const e=GridAreaRowRegex.exec(t);e&&0===e.index&&!r.trimRight().endsWith("]")&&(r=r.trimRight()+"\n"+i)}o||":"!==t||(o=r),r+=t}})),l&&(a+=r),a=a.substring(2,a.length-1).trimRight(),a+(e?"\n"+s:"")}_detectIndentation(t){const e=t.split("\n");return e.length<2?"":TextUtils.TextUtils.lineIndent(e[1])}setValue(t,e,s,n){const i=this.name+": "+t+(this.important?" !important":"")+";";this.setText(i,e,s).then(n)}setDisabled(t){if(!this.ownerStyle)return Promise.resolve(!1);if(t===this.disabled)return Promise.resolve(!0);const e=this.text.trim(),s=t?"/* "+e+" */":this.text.substring(2,e.length-2).trim();return this.setText(s,!0,!0)}}