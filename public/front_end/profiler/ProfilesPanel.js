import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{DataDisplayDelegate,Events as ProfileHeaderEvents,ProfileEvents as ProfileTypeEvents,ProfileHeader,ProfileType}from"./ProfileHeader.js";import{Events as ProfileLauncherEvents,ProfileLauncherView}from"./ProfileLauncherView.js";import{ProfileSidebarTreeElement}from"./ProfileSidebarTreeElement.js";import{instance}from"./ProfileTypeRegistry.js";export class ProfilesPanel extends UI.Panel.PanelWithSidebar{constructor(e,i,t){super(e),this._profileTypes=i,this.registerRequiredCSS("profiler/heapProfiler.css"),this.registerRequiredCSS("profiler/profilesPanel.css"),this.registerRequiredCSS("object_ui/objectValue.css");const r=new UI.Widget.VBox;this.splitWidget().setMainWidget(r),this.profilesItemTreeElement=new ProfilesSidebarTreeElement(this),this._sidebarTree=new UI.TreeOutline.TreeOutlineInShadow,this._sidebarTree.registerRequiredCSS("profiler/profilesSidebarTree.css"),this._sidebarTree.element.classList.add("profiles-sidebar-tree-box"),this.panelSidebarElement().appendChild(this._sidebarTree.element),this._sidebarTree.appendChild(this.profilesItemTreeElement),this._sidebarTree.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),this.profileViews=createElement("div"),this.profileViews.id="profile-views",this.profileViews.classList.add("vbox"),r.element.appendChild(this.profileViews),this._toolbarElement=createElementWithClass("div","profiles-toolbar"),r.element.insertBefore(this._toolbarElement,r.element.firstChild),this.panelSidebarElement().classList.add("profiles-tree-sidebar");const l=createElementWithClass("div","profiles-toolbar");this.panelSidebarElement().insertBefore(l,this.panelSidebarElement().firstChild);const s=new UI.Toolbar.Toolbar("",l);this._toggleRecordAction=self.UI.actionRegistry.action(t),this._toggleRecordButton=UI.Toolbar.Toolbar.createActionButton(this._toggleRecordAction),s.appendToolbarItem(this._toggleRecordButton),this.clearResultsButton=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Clear all profiles"),"largeicon-clear"),this.clearResultsButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._reset,this),s.appendToolbarItem(this.clearResultsButton),s.appendSeparator(),s.appendToolbarItem(UI.Toolbar.Toolbar.createActionButtonForId("components.collect-garbage")),this._profileViewToolbar=new UI.Toolbar.Toolbar("",this._toolbarElement),this._profileGroups={},this._launcherView=new ProfileLauncherView(this),this._launcherView.addEventListener(ProfileLauncherEvents.ProfileTypeSelected,this._onProfileTypeSelected,this),this._profileToView=[],this._typeIdToSidebarSection={};const o=this._profileTypes;for(let e=0;e<o.length;e++)this._registerProfileType(o[e]);this._launcherView.restoreSelectedProfileType(),this.profilesItemTreeElement.select(),this._showLauncherView(),this._createFileSelectorElement(),this.element.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),SDK.SDKModel.TargetManager.instance().addEventListener(SDK.SDKModel.Events.SuspendStateChanged,this._onSuspendStateChanged,this),self.UI.context.addFlavorChangeListener(SDK.CPUProfilerModel.CPUProfilerModel,this._updateProfileTypeSpecificUI,this),self.UI.context.addFlavorChangeListener(SDK.HeapProfilerModel.HeapProfilerModel,this._updateProfileTypeSpecificUI,this)}_onKeyDown(e){let i=!1;"ArrowDown"!==e.key||e.altKey?"ArrowUp"!==e.key||e.altKey||(i=this._sidebarTree.selectPrevious()):i=this._sidebarTree.selectNext(),i&&e.consume(!0)}searchableView(){return this.visibleView&&this.visibleView.searchableView?this.visibleView.searchableView():null}_createFileSelectorElement(){this._fileSelectorElement&&this.element.removeChild(this._fileSelectorElement),this._fileSelectorElement=UI.UIUtils.createFileSelectorElement(this._loadFromFile.bind(this)),ProfilesPanel._fileSelectorElement=this._fileSelectorElement,this.element.appendChild(this._fileSelectorElement)}_findProfileTypeByExtension(e){return this._profileTypes.find(i=>!!i.fileExtension()&&e.endsWith(i.fileExtension()||""))||null}async _loadFromFile(e){this._createFileSelectorElement();const i=this._findProfileTypeByExtension(e.name);if(!i){const e=new Set(this._profileTypes.map(e=>e.fileExtension()).filter(e=>e));return void Common.Console.Console.instance().error(Common.UIString.UIString("Can’t load file. Supported file extensions: `%s`.",Array.from(e).join("', '")))}if(i.profileBeingRecorded())return void Common.Console.Console.instance().error(Common.UIString.UIString("Can’t load profile while another profile is being recorded."));const t=await i.loadFromFile(e);t&&UI.UIUtils.MessageDialog.show(Common.UIString.UIString("Profile loading failed: %s.",t.message))}toggleRecord(){if(!this._toggleRecordAction.enabled())return!0;const e=this.element.ownerDocument.deepActiveElement(),i=this._selectedProfileType,t=i.buttonClicked();return this._updateToggleRecordAction(t),t?(this._launcherView.profileStarted(),i.hasTemporaryView()&&this.showProfile(i.profileBeingRecorded())):this._launcherView.profileFinished(),e&&e.focus(),!0}_onSuspendStateChanged(){this._updateToggleRecordAction(this._toggleRecordAction.toggled())}_updateToggleRecordAction(e){const i=!(!self.UI.context.flavor(SDK.CPUProfilerModel.CPUProfilerModel)&&!self.UI.context.flavor(SDK.HeapProfilerModel.HeapProfilerModel)),t=e||!SDK.SDKModel.TargetManager.instance().allTargetsSuspended()&&i;this._toggleRecordAction.setEnabled(t),this._toggleRecordAction.setToggled(e),t?this._toggleRecordButton.setTitle(this._selectedProfileType?this._selectedProfileType.buttonTooltip:""):this._toggleRecordButton.setTitle(UI.UIUtils.anotherProfilerActiveLabel()),this._selectedProfileType&&this._launcherView.updateProfileType(this._selectedProfileType,t)}_profileBeingRecordedRemoved(){this._updateToggleRecordAction(!1),this._launcherView.profileFinished()}_onProfileTypeSelected(e){this._selectedProfileType=e.data,this._updateProfileTypeSpecificUI()}_updateProfileTypeSpecificUI(){this._updateToggleRecordAction(this._toggleRecordAction.toggled())}_reset(){this._profileTypes.forEach(e=>e.reset()),delete this.visibleView,this._profileGroups={},this._updateToggleRecordAction(!1),this._launcherView.profileFinished(),this._sidebarTree.element.classList.remove("some-expandable"),this._launcherView.detach(),this.profileViews.removeChildren(),this._profileViewToolbar.removeToolbarItems(),this.clearResultsButton.element.classList.remove("hidden"),this.profilesItemTreeElement.select(),this._showLauncherView()}_showLauncherView(){this.closeVisibleView(),this._profileViewToolbar.removeToolbarItems(),this._launcherView.show(this.profileViews),this.visibleView=this._launcherView,this._toolbarElement.classList.add("hidden")}_registerProfileType(e){this._launcherView.addProfileType(e);const i=new ProfileTypeSidebarSection(this,e);this._typeIdToSidebarSection[e.id]=i,this._sidebarTree.appendChild(i),i.childrenListElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),e.addEventListener(ProfileTypeEvents.ViewUpdated,this._updateProfileTypeSpecificUI,this),e.addEventListener(ProfileTypeEvents.AddProfileHeader,(function(e){this._addProfileHeader(e.data)}),this),e.addEventListener(ProfileTypeEvents.RemoveProfileHeader,(function(e){this._removeProfileHeader(e.data)}),this),e.addEventListener(ProfileTypeEvents.ProfileComplete,(function(e){this.showProfile(e.data)}),this);const t=e.getProfiles();for(let e=0;e<t.length;e++)this._addProfileHeader(t[e])}_handleContextMenuEvent(e){const i=new UI.ContextMenu.ContextMenu(e);this.panelSidebarElement().isSelfOrAncestor(e.srcElement)&&i.defaultSection().appendItem(Common.UIString.UIString("Load…"),this._fileSelectorElement.click.bind(this._fileSelectorElement)),i.show()}showLoadFromFileDialog(){this._fileSelectorElement.click()}_addProfileHeader(e){const i=e.profileType().id;this._typeIdToSidebarSection[i].addProfileHeader(e),this.visibleView&&this.visibleView!==this._launcherView||this.showProfile(e)}_removeProfileHeader(e){e.profileType().profileBeingRecorded()===e&&this._profileBeingRecordedRemoved();const i=this._indexOfViewForProfile(e);-1!==i&&this._profileToView.splice(i,1);const t=e.profileType().id;this._typeIdToSidebarSection[t].removeProfileHeader(e)&&(this.profilesItemTreeElement.select(),this._showLauncherView())}showProfile(e){if(!e||e.profileType().profileBeingRecorded()===e&&!e.profileType().hasTemporaryView())return null;const i=this.viewForProfile(e);if(i===this.visibleView)return i;this.closeVisibleView(),i.show(this.profileViews),this._toolbarElement.classList.remove("hidden"),this.visibleView=i;return this._typeIdToSidebarSection[e.profileType().id].sidebarElementForProfile(e).revealAndSelect(),this._profileViewToolbar.removeToolbarItems(),i.toolbarItems().then(e=>{e.map(e=>this._profileViewToolbar.appendToolbarItem(e))}),i}showObject(e,i){}async linkifyObject(e){return null}viewForProfile(e){const i=this._indexOfViewForProfile(e);if(-1!==i)return this._profileToView[i].view;const t=e.createView(this);return t.element.classList.add("profile-view"),this._profileToView.push({profile:e,view:t}),t}_indexOfViewForProfile(e){return this._profileToView.findIndex(i=>i.profile===e)}closeVisibleView(){this.visibleView&&this.visibleView.detach(),delete this.visibleView}focus(){this._sidebarTree.focus()}}export class ProfileTypeSidebarSection extends UI.TreeOutline.TreeElement{constructor(e,i){super(i.treeItemTitle,!0),this.selectable=!1,this._dataDisplayDelegate=e,this._profileTreeElements=[],this._profileGroups={},this.expand(),this.hidden=!0,this.setCollapsible(!1)}addProfileHeader(e){this.hidden=!1;const i=e.profileType();let t=this;const r=e.createSidebarTreeElement(this._dataDisplayDelegate);if(this._profileTreeElements.push(r),!e.fromFile()&&i.profileBeingRecorded()!==e){const i=e.title;let l=this._profileGroups[i];l||(l=new ProfileGroup,this._profileGroups[i]=l),l.profileSidebarTreeElements.push(r);const s=l.profileSidebarTreeElements.length;if(2===s){l.sidebarTreeElement=new ProfileGroupSidebarTreeElement(this._dataDisplayDelegate,e.title);const i=l.profileSidebarTreeElements[0],t=this.children().indexOf(i);this.insertChild(l.sidebarTreeElement,t);const r=i.selected;this.removeChild(i),l.sidebarTreeElement.appendChild(i),r&&i.revealAndSelect(),i.setSmall(!0),i.setMainTitle(Common.UIString.UIString("Run %d",1)),this.treeOutline.element.classList.add("some-expandable")}s>=2&&(t=l.sidebarTreeElement,r.setSmall(!0),r.setMainTitle(Common.UIString.UIString("Run %d",s)))}t.appendChild(r)}removeProfileHeader(e){const i=this._sidebarElementIndex(e);if(-1===i)return!1;const t=this._profileTreeElements[i];this._profileTreeElements.splice(i,1);let r=this;const l=this._profileGroups[e.title];if(l){const i=l.profileSidebarTreeElements;if(i.splice(i.indexOf(t),1),1===i.length){const t=r.children().indexOf(l.sidebarTreeElement);l.sidebarTreeElement.removeChild(i[0]),this.insertChild(i[0],t),i[0].setSmall(!1),i[0].setMainTitle(e.title),this.removeChild(l.sidebarTreeElement)}0!==i.length&&(r=l.sidebarTreeElement)}return r.removeChild(t),t.dispose(),!this.childCount()&&(this.hidden=!0,!0)}sidebarElementForProfile(e){const i=this._sidebarElementIndex(e);return-1===i?null:this._profileTreeElements[i]}_sidebarElementIndex(e){const i=this._profileTreeElements;for(let t=0;t<i.length;t++)if(i[t].profile===e)return t;return-1}onattach(){this.listItemElement.classList.add("profiles-tree-section")}}export class ProfileGroup{constructor(){this.profileSidebarTreeElements=[],this.sidebarTreeElement=null}}export class ProfileGroupSidebarTreeElement extends UI.TreeOutline.TreeElement{constructor(e,i){super("",!0),this.selectable=!1,this._dataDisplayDelegate=e,this._title=i,this.expand(),this.toggleOnClick=!0}onselect(){const e=this.childCount()>0;return e&&this._dataDisplayDelegate.showProfile(this.lastChild().profile),e}onattach(){this.listItemElement.classList.add("profile-group-sidebar-tree-item"),this.listItemElement.createChild("div","icon"),this.listItemElement.createChild("div","titles no-subtitle").createChild("span","title-container").createChild("span","title").textContent=this._title}}export class ProfilesSidebarTreeElement extends UI.TreeOutline.TreeElement{constructor(e){super("",!1),this.selectable=!0,this._panel=e}onselect(){return this._panel._showLauncherView(),!0}onattach(){this.listItemElement.classList.add("profile-launcher-view-tree-item"),this.listItemElement.createChild("div","icon"),this.listItemElement.createChild("div","titles no-subtitle").createChild("span","title-container").createChild("span","title").textContent=Common.UIString.UIString("Profiles")}}export class JSProfilerPanel extends ProfilesPanel{constructor(){super("js_profiler",[instance.cpuProfileType],"profiler.js-toggle-recording")}wasShown(){self.UI.context.setFlavor(JSProfilerPanel,this)}willHide(){self.UI.context.setFlavor(JSProfilerPanel,null)}handleAction(e,i){const t=self.UI.context.flavor(JSProfilerPanel);return console.assert(t&&t instanceof JSProfilerPanel),t.toggleRecord(),!0}}