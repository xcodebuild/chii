import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as HostModule from"../host/host.js";import*as SDK from"../sdk/sdk.js";import*as Timeline from"../timeline/timeline.js";import*as UI from"../ui/ui.js";const MaxLengthForLinks=40;export class LighthouseReportRenderer extends ReportRenderer{static addViewTraceButton(e,t){if(!t||!t.traces||!t.traces.defaultPass)return;const o=e.querySelector(".lh-audit-group"),n=o.querySelector(".lh-columns");if(!n)return;const s=t.traces.defaultPass,i=UI.UIUtils.createTextButton(Common.UIString.UIString("View Trace"),(async function(){HostModule.userMetrics.actionTaken(Host.UserMetrics.Action.LighthouseViewTrace),await self.UI.inspectorView.showPanel("timeline"),Timeline.TimelinePanel.TimelinePanel.instance().loadFromEvents(s.traceEvents)}),"view-trace");o.insertBefore(i,n.nextSibling)}static async linkifyNodeDetails(e){const t=SDK.SDKModel.TargetManager.instance().mainTarget().model(SDK.DOMModel.DOMModel);for(const o of e.getElementsByClassName("lh-node")){const e=o.dataset;if(!e.path)continue;const n=await t.pushNodeByPathToFrontend(e.path);if(!n)continue;const s=t.nodeForId(n);if(!s)continue;const i=await Common.Linkifier.Linkifier.linkify(s,{tooltip:e.snippet});o.title="",o.textContent="",o.appendChild(i)}}static async linkifySourceLocationDetails(e){for(const t of e.getElementsByClassName("lh-source-location")){const e=t.dataset;if(!e.sourceUrl||!e.sourceLine||!e.sourceColumn)continue;const o=e.sourceUrl,n=Number(e.sourceLine),s=Number(e.sourceColumn),i=await Components.Linkifier.Linkifier.linkifyURL(o,{lineNumber:n,column:s,maxLength:40});t.title="",t.textContent="",t.appendChild(i)}}static handleDarkMode(e){"dark"===self.UI.themeSupport.themeName()&&e.classList.add("dark")}}export class LighthouseReportUIFeatures extends ReportUIFeatures{constructor(e){super(e),this._beforePrint=null,this._afterPrint=null}setBeforePrint(e){this._beforePrint=e}setAfterPrint(e){this._afterPrint=e}getReportHtml(){return this.resetUIState(),Lighthouse.ReportGenerator.generateReportHtml(this.json)}async _saveFile(e){const t=`${new Common.ParsedURL.ParsedURL(this.json.finalUrl).domain().replace(/[^a-z0-9.-]+/gi,"_")}-${new Date(this.json.fetchTime).toISO8601Compact()}${e.type.match("json")?".json":".html"}`,o=await e.text();self.Workspace.fileManager.save(t,o,!0)}async _print(){const e=this.getDocument().querySelector(".lh-root").cloneNode(!0),t=window.open("","_blank","channelmode=1,status=1,resizable=1"),o=t.document.createElement("style");o.textContent=self.Runtime.cachedResources["third_party/lighthouse/report-assets/report.css"],t.document.head.appendChild(o),t.document.body.replaceWith(e),await LighthouseReportRenderer.linkifyNodeDetails(e),this._beforePrint&&this._beforePrint(),t.focus(),t.print(),t.close(),this._afterPrint&&this._afterPrint()}getDocument(){return this._document}resetUIState(){this._resetUIState()}}