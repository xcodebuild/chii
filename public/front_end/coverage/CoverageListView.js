import*as Common from"../common/common.js";import*as DataGrid from"../data_grid/data_grid.js";import*as Formatter from"../formatter/formatter.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";import{CoverageType,URLCoverageInfo}from"./CoverageModel.js";export class CoverageListView extends UI.Widget.VBox{constructor(e){super(!0),this._nodeForCoverageInfo=new Map,this._filterCallback=e,this._highlightRegExp=null,this.registerRequiredCSS("coverage/coverageListView.css");const t=[{id:"url",title:Common.UIString.UIString("URL"),width:"250px",fixedWidth:!1,sortable:!0},{id:"type",title:Common.UIString.UIString("Type"),width:"45px",fixedWidth:!0,sortable:!0},{id:"size",title:Common.UIString.UIString("Total Bytes"),width:"60px",fixedWidth:!0,sortable:!0,align:DataGrid.DataGrid.Align.Right},{id:"unusedSize",title:Common.UIString.UIString("Unused Bytes"),width:"100px",fixedWidth:!0,sortable:!0,align:DataGrid.DataGrid.Align.Right,sort:DataGrid.DataGrid.Order.Descending},{id:"bars",title:ls`Usage Visualization`,width:"250px",fixedWidth:!1,sortable:!0}];this._dataGrid=new DataGrid.SortableDataGrid.SortableDataGrid({displayName:ls`Code Coverage`,columns:t}),this._dataGrid.setResizeMethod(DataGrid.DataGrid.ResizeMethod.Last),this._dataGrid.element.classList.add("flex-auto"),this._dataGrid.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.OpenedNode,this._onOpenedNode,this),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SortingChanged,this._sortingChanged,this);const i=this._dataGrid.asWidget();i.show(this.contentElement),this.setDefaultFocusedChild(i)}update(e){let t=!1;const i=e.reduce((e,t)=>Math.max(e,t.size()),0),r=this._dataGrid.rootNode();for(const s of e){let e=this._nodeForCoverageInfo.get(s);e?this._filterCallback(e._coverageInfo)&&(t=e._refreshIfNeeded(i)||t):(e=new GridNode(s,i),this._nodeForCoverageInfo.set(s,e),this._filterCallback(e._coverageInfo)&&(r.appendChild(e),t=!0))}t&&this._sortingChanged()}reset(){this._nodeForCoverageInfo.clear(),this._dataGrid.rootNode().removeChildren()}updateFilterAndHighlight(e){this._highlightRegExp=e;let t=!1;for(const e of this._nodeForCoverageInfo.values()){const i=this._filterCallback(e._coverageInfo),r=!!e.parent;i&&e._setHighlight(this._highlightRegExp),i!==r&&(t=!0,i?this._dataGrid.rootNode().appendChild(e):e.remove())}t&&this._sortingChanged()}selectByUrl(e){for(const[t,i]of this._nodeForCoverageInfo.entries())if(t.url()===e){i.revealAndSelect();break}}_onOpenedNode(){this._revealSourceForSelectedNode()}_onKeyDown(e){isEnterKey(e)&&(e.consume(!0),this._revealSourceForSelectedNode())}async _revealSourceForSelectedNode(){const e=this._dataGrid.selectedNode;if(!e)return;const t=e._coverageInfo;let i=Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(t.url());if(!i)return;i=(await Formatter.sourceFormatter.format(i)).formattedSourceCode,this._dataGrid.selectedNode===e&&Common.Revealer.reveal(i)}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;let t;switch(e){case"url":t=i;break;case"type":t=function(e,t){const r=e,s=t,a=CoverageListView._typeToString(r._coverageInfo.type()),o=CoverageListView._typeToString(s._coverageInfo.type());return a.localeCompare(o)||i(e,t)};break;case"size":t=r.bind(null,"size");break;case"bars":case"unusedSize":t=r.bind(null,"unusedSize");break;default:return void console.assert(!1,"Unknown sort field: "+e)}function i(e,t){const i=t;return e._url.localeCompare(i._url)}function r(e,t,r){const s=r;return t._coverageInfo[e]()-s._coverageInfo[e]()||i(t,r)}this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}static _typeToString(e){const t=[];return e&CoverageType.CSS&&t.push(Common.UIString.UIString("CSS")),e&CoverageType.JavaScriptPerFunction?t.push(Common.UIString.UIString("JS (per function)")):e&CoverageType.JavaScript&&t.push(Common.UIString.UIString("JS (per block)")),t.join("+")}}export class GridNode extends DataGrid.SortableDataGrid.SortableDataGridNode{constructor(e,t){super(),this._coverageInfo=e,this._lastUsedSize,this._url=e.url(),this._maxSize=t,this._highlightDOMChanges=[],this._highlightRegExp=null}_setHighlight(e){this._highlightRegExp!==e&&(this._highlightRegExp=e,this.refresh())}_refreshIfNeeded(e){return(this._lastUsedSize!==this._coverageInfo.usedSize()||e!==this._maxSize)&&(this._lastUsedSize=this._coverageInfo.usedSize(),this._maxSize=e,this.refresh(),!0)}createCell(e){const t=this.createTD(e);switch(e){case"url":{t.title=this._url;const i=t.createChild("div","url-outer"),r=i.createChild("div","url-prefix"),s=i.createChild("div","url-suffix"),a=/^(.*)(\/[^/]*)$/.exec(this._url);r.textContent=a?a[1]:this._url,s.textContent=a?a[2]:"",this._highlightRegExp&&this._highlight(i,this._url),this.setCellAccessibleName(this._url,t,e);break}case"type":t.textContent=CoverageListView._typeToString(this._coverageInfo.type()),this._coverageInfo.type()&CoverageType.JavaScriptPerFunction?t.title=ls`JS coverage with per function granularity: Once a function was executed, the whole function is marked as covered.`:this._coverageInfo.type()&CoverageType.JavaScript&&(t.title=ls`JS coverage with per block granularity: Once a block of JavaScript was executed, that block is marked as covered.`);break;case"size":{t.createChild("span").textContent=Number.withThousandsSeparator(this._coverageInfo.size()||0);const i=1===this._coverageInfo.size()?ls`1 byte`:ls`${this._coverageInfo.size()||0} bytes`;this.setCellAccessibleName(i,t,e);break}case"unusedSize":{const i=this._coverageInfo.unusedSize()||0,r=t.createChild("span"),s=t.createChild("span","percent-value");r.textContent=Number.withThousandsSeparator(i);const a=ls`${this._percentageString(this._coverageInfo.unusedPercentage())} %`;s.textContent=a;const o=1===i?ls`1 byte, ${a}`:ls`${i} bytes, ${a}`;this.setCellAccessibleName(o,t,e);break}case"bars":{const i=t.createChild("div","bar-container"),r=this._percentageString(this._coverageInfo.unusedPercentage()),s=this._percentageString(this._coverageInfo.usedPercentage());if(this._coverageInfo.unusedSize()>0){const e=i.createChild("div","bar bar-unused-size");e.style.width=(this._coverageInfo.unusedSize()/this._maxSize*100||0)+"%",this._coverageInfo.type()&CoverageType.JavaScriptPerFunction?e.title=ls`${this._coverageInfo.unusedSize()} bytes (${r} %) belong to functions that have not (yet) been executed.`:this._coverageInfo.type()&CoverageType.JavaScript&&(e.title=ls`${this._coverageInfo.unusedSize()} bytes (${r} %) belong to blocks of JavaScript that have not (yet) been executed.`)}if(this._coverageInfo.usedSize()>0){const e=i.createChild("div","bar bar-used-size");e.style.width=(this._coverageInfo.usedSize()/this._maxSize*100||0)+"%",this._coverageInfo.type()&CoverageType.JavaScriptPerFunction?e.title=ls`${this._coverageInfo.usedSize()} bytes (${s} %) belong to functions that have executed at least once.`:this._coverageInfo.type()&CoverageType.JavaScript&&(e.title=ls`${this._coverageInfo.usedSize()} bytes (${s} %) belong to blocks of JavaScript that have executed at least once.`)}this.setCellAccessibleName(ls`${r} % of file unused, ${s} % of file used`,t,e)}}return t}_percentageString(e){return e.toFixed(1)}_highlight(e,t){const i=this._highlightRegExp.exec(t);if(!i||!i.length)return;const r=new TextUtils.TextRange.SourceRange(i.index,i[0].length);UI.UIUtils.highlightRangesWithStyleClass(e,[r],"filter-highlight")}}