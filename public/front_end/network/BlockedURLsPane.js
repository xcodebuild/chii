import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export let _instance=null;export class BlockedURLsPane extends UI.Widget.VBox{constructor(){super(!0),this.registerRequiredCSS("network/blockedURLsPane.css"),_instance=this,this._manager=self.SDK.multitargetNetworkManager,this._manager.addEventListener(SDK.NetworkManager.MultitargetNetworkManager.Events.BlockedPatternsChanged,this._update,this),this._toolbar=new UI.Toolbar.Toolbar("",this.contentElement),this._enabledCheckbox=new UI.Toolbar.ToolbarCheckbox(Common.UIString.UIString("Enable request blocking"),void 0,this._toggleEnabled.bind(this)),this._toolbar.appendToolbarItem(this._enabledCheckbox),this._toolbar.appendSeparator();const e=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Add pattern"),"largeicon-add");e.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._addButtonClicked,this),this._toolbar.appendToolbarItem(e);const t=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Remove all patterns"),"largeicon-clear");t.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._removeAll,this),this._toolbar.appendToolbarItem(t),this._list=new UI.ListWidget.ListWidget(this),this._list.element.classList.add("blocked-urls"),this._list.registerRequiredCSS("network/blockedURLsPane.css"),this._list.setEmptyPlaceholder(this._createEmptyPlaceholder()),this._list.show(this.contentElement),this._editor=null,this._blockedCountForUrl=new Map,SDK.SDKModel.TargetManager.instance().addModelListener(SDK.NetworkManager.NetworkManager,SDK.NetworkManager.Events.RequestFinished,this._onRequestFinished,this),this._updateThrottler=new Common.Throttler.Throttler(200),this._update()}_createEmptyPlaceholder(){const e=this.contentElement.createChild("div","no-blocked-urls"),t=UI.UIUtils.createTextButton(ls`Add pattern`,this._addButtonClicked.bind(this),"add-button");return UI.ARIAUtils.setAccessibleName(t,ls`Add request blocking pattern`),e.appendChild(UI.UIUtils.formatLocalized("Requests are not blocked. %s",[t])),e}static reset(){_instance&&_instance.reset()}_addButtonClicked(){this._manager.setBlockingEnabled(!0),this._list.addNewItem(0,{url:"",enabled:!0})}renderItem(e,t){const r=this._blockedRequestsCount(e.url),n=createElementWithClass("div","blocked-url"),o=n.createChild("input","blocked-url-checkbox");return o.type="checkbox",o.checked=e.enabled,o.disabled=!this._manager.blockingEnabled(),n.createChild("div","blocked-url-label").textContent=e.url,n.createChild("div","blocked-url-count").textContent=Common.UIString.UIString("%d blocked",r),n.addEventListener("click",t=>this._togglePattern(e,t),!1),o.addEventListener("click",t=>this._togglePattern(e,t),!1),n}_togglePattern(e,t){t.consume(!0);const r=this._manager.blockedPatterns();r.splice(r.indexOf(e),1,{enabled:!e.enabled,url:e.url}),this._manager.setBlockedPatterns(r)}_toggleEnabled(){this._manager.setBlockingEnabled(!this._manager.blockingEnabled()),this._update()}removeItemRequested(e,t){const r=this._manager.blockedPatterns();r.splice(t,1),this._manager.setBlockedPatterns(r)}beginEdit(e){return this._editor=this._createEditor(),this._editor.control("url").value=e.url,this._editor}commitEdit(e,t,r){const n=t.control("url").value,o=this._manager.blockedPatterns();r?o.push({enabled:!0,url:n}):o.splice(o.indexOf(e),1,{enabled:!0,url:n}),this._manager.setBlockedPatterns(o)}_createEditor(){if(this._editor)return this._editor;const e=new UI.ListWidget.Editor,t=e.contentElement();t.createChild("div","blocked-url-edit-row").createChild("div").textContent=Common.UIString.UIString("Text pattern to block matching requests; use * for wildcard");const r=t.createChild("div","blocked-url-edit-row"),n=e.createInput("url","text","",(e,t,r)=>{let n,o=!0;return r.value?this._manager.blockedPatterns().find(e=>e.url===r.value)&&(n=ls`Pattern already exists.`,o=!1):(n=ls`Pattern input cannot be empty.`,o=!1),{valid:o,errorMessage:n}});return r.createChild("div","blocked-url-edit-value").appendChild(n),e}_removeAll(){this._manager.setBlockedPatterns([])}_update(){const e=this._manager.blockingEnabled();this._list.element.classList.toggle("blocking-disabled",!e&&!!this._manager.blockedPatterns().length),this._enabledCheckbox.setChecked(e),this._list.clear();for(const e of this._manager.blockedPatterns())this._list.appendItem(e,!0);return Promise.resolve()}_blockedRequestsCount(e){if(!e)return 0;let t=0;for(const r of this._blockedCountForUrl.keys())this._matches(e,r)&&(t+=this._blockedCountForUrl.get(r));return t}_matches(e,t){let r=0;const n=e.split("*");for(let e=0;e<n.length;e++){const o=n[e];if(o.length){if(r=t.indexOf(o,r),-1===r)return!1;r+=o.length}}return!0}reset(){this._blockedCountForUrl.clear(),this._updateThrottler.schedule(this._update.bind(this))}_onRequestFinished(e){const t=e.data;if(t.wasBlocked()){const e=this._blockedCountForUrl.get(t.url())||0;this._blockedCountForUrl.set(t.url(),e+1),this._updateThrottler.schedule(this._update.bind(this))}}}