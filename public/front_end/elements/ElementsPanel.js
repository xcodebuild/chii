import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as Extensions from"../extensions/extensions.js";import*as Host from"../host/host.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{ComputedStyleWidget}from"./ComputedStyleWidget.js";import{ElementsBreadcrumbs,Events}from"./ElementsBreadcrumbs.js";import{ElementsTreeElement}from"./ElementsTreeElement.js";import{ElementsTreeElementHighlighter}from"./ElementsTreeElementHighlighter.js";import{ElementsTreeOutline}from"./ElementsTreeOutline.js";import{MarkerDecorator}from"./MarkerDecorator.js";import{MetricsSidebarPane}from"./MetricsSidebarPane.js";import{StylesSidebarPane}from"./StylesSidebarPane.js";export class ElementsPanel extends UI.Panel.Panel{constructor(){super("elements"),this.registerRequiredCSS("elements/elementsPanel.css"),this._splitWidget=new UI.SplitWidget.SplitWidget(!0,!0,"elementsPanelSplitViewState",325,325),this._splitWidget.addEventListener(UI.SplitWidget.Events.SidebarSizeChanged,this._updateTreeOutlineVisibleWidth.bind(this)),this._splitWidget.show(this.element),this._searchableView=new UI.SearchableView.SearchableView(this),this._searchableView.setMinimumSize(25,28),this._searchableView.setPlaceholder(Common.UIString.UIString("Find by string, selector, or XPath"));const e=this._searchableView.element;this._contentElement=createElement("div");const t=createElement("div");e.appendChild(this._contentElement),e.appendChild(t),this._splitWidget.setMainWidget(this._searchableView),this._splitMode=null,this._contentElement.id="elements-content",Common.Settings.Settings.instance().moduleSetting("domWordWrap").get()&&this._contentElement.classList.add("elements-wrap"),Common.Settings.Settings.instance().moduleSetting("domWordWrap").addChangeListener(this._domWordWrapSettingChanged.bind(this)),t.id="elements-crumbs",this._breadcrumbs=new ElementsBreadcrumbs,this._breadcrumbs.show(t),this._breadcrumbs.addEventListener(Events.NodeSelected,this._crumbNodeSelected,this),this._stylesWidget=new StylesSidebarPane,this._computedStyleWidget=new ComputedStyleWidget,this._metricsWidget=new MetricsSidebarPane,Common.Settings.Settings.instance().moduleSetting("sidebarPosition").addChangeListener(this._updateSidebarPosition.bind(this)),this._updateSidebarPosition(),this._treeOutlines=new Set,this._treeOutlineHeaders=new Map,SDK.SDKModel.TargetManager.instance().observeModels(SDK.DOMModel.DOMModel,this),SDK.SDKModel.TargetManager.instance().addEventListener(SDK.SDKModel.Events.NameChanged,e=>this._targetNameChanged(e.data)),Common.Settings.Settings.instance().moduleSetting("showUAShadowDOM").addChangeListener(this._showUAShadowDOMChanged.bind(this)),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DOMModel.DOMModel,SDK.DOMModel.Events.DocumentUpdated,this._documentUpdatedEvent,this),self.Extensions.extensionServer.addEventListener(Extensions.ExtensionServer.Events.SidebarPaneAdded,this._extensionSidebarPaneAdded,this),this._searchResults}static instance(){return self.runtime.sharedInstance(ElementsPanel)}_revealProperty(e){return this.sidebarPaneView.showView(this._stylesViewToReveal).then(()=>{this._stylesWidget.revealProperty(e)})}resolveLocation(e){return this.sidebarPaneView}showToolbarPane(e,t){this._stylesWidget.showToolbarPane(e,t)}modelAdded(e){const t=e.parentModel();let s=t?ElementsTreeOutline.forDOMModel(t):null;s||(s=new ElementsTreeOutline(!0,!0),s.setWordWrap(Common.Settings.Settings.instance().moduleSetting("domWordWrap").get()),s.addEventListener(ElementsTreeOutline.Events.SelectedNodeChanged,this._selectedNodeChanged,this),s.addEventListener(ElementsTreeOutline.Events.ElementsTreeUpdated,this._updateBreadcrumbIfNeeded,this),new ElementsTreeElementHighlighter(s),this._treeOutlines.add(s),e.target().parentTarget()&&(this._treeOutlineHeaders.set(s,createElementWithClass("div","elements-tree-header")),this._targetNameChanged(e.target()))),s.wireToDOMModel(e),this.isShowing()&&this.wasShown()}modelRemoved(e){const t=ElementsTreeOutline.forDOMModel(e);if(t.unwireFromDOMModel(e),e.parentModel())return;this._treeOutlines.delete(t);const s=this._treeOutlineHeaders.get(t);s&&s.remove(),this._treeOutlineHeaders.delete(t),t.element.remove()}_targetNameChanged(e){const t=e.model(SDK.DOMModel.DOMModel);if(!t)return;const s=ElementsTreeOutline.forDOMModel(t);if(!s)return;const n=this._treeOutlineHeaders.get(s);n&&(n.removeChildren(),n.createChild("div","elements-tree-header-frame").textContent=Common.UIString.UIString("Frame"),n.appendChild(Components.Linkifier.Linkifier.linkifyURL(e.inspectedURL(),{text:e.name()})))}_updateTreeOutlineVisibleWidth(){if(!this._treeOutlines.size)return;let e=this._splitWidget.element.offsetWidth;this._splitWidget.isVertical()&&(e-=this._splitWidget.sidebarSize());for(const t of this._treeOutlines)t.setVisibleWidth(e);this._breadcrumbs.updateSizes()}focus(){this._treeOutlines.size&&this._treeOutlines.values().next().value.focus()}searchableView(){return this._searchableView}wasShown(){self.UI.context.setFlavor(ElementsPanel,this);for(const e of this._treeOutlines)if(e.element.parentElement!==this._contentElement){const t=this._treeOutlineHeaders.get(e);t&&this._contentElement.appendChild(t),this._contentElement.appendChild(e.element)}super.wasShown(),this._breadcrumbs.update();const e=SDK.SDKModel.TargetManager.instance().models(SDK.DOMModel.DOMModel);for(const t of e){if(t.parentModel())continue;const e=ElementsTreeOutline.forDOMModel(t);e.setVisible(!0),e.rootDOMNode||(t.existingDocument()?(e.rootDOMNode=t.existingDocument(),this._documentUpdated(t)):t.requestDocument())}}willHide(){SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight();for(const e of this._treeOutlines){e.setVisible(!1),this._contentElement.removeChild(e.element);const t=this._treeOutlineHeaders.get(e);t&&this._contentElement.removeChild(t)}super.willHide(),self.UI.context.setFlavor(ElementsPanel,null)}onResize(){this.element.window().requestAnimationFrame(this._updateSidebarPosition.bind(this)),this._updateTreeOutlineVisibleWidth()}_selectedNodeChanged(e){const t=e.data.node,s=e.data.focus;for(const e of this._treeOutlines)t&&ElementsTreeOutline.forDOMModel(t.domModel())===e||e.selectDOMNode(null);if(this._breadcrumbs.setSelectedNode(t),self.UI.context.setFlavor(SDK.DOMModel.DOMNode,t),!t)return;t.setAsInspectedNode(),s&&(this._selectedNodeOnReset=t,this._hasNonDefaultSelectedNode=!0);const n=t.domModel().runtimeModel().executionContexts(),i=t.frameId();for(const e of n)if(e.frameId===i){self.UI.context.setFlavor(SDK.RuntimeModel.ExecutionContext,e);break}}_documentUpdatedEvent(e){const t=e.data;this._documentUpdated(t)}_documentUpdated(e){if(this._searchableView.resetSearch(),!e.existingDocument())return void(this.isShowing()&&e.requestDocument());if(this._hasNonDefaultSelectedNode=!1,this._omitDefaultSelection)return;const t=this._selectedNodeOnReset;(async function(e,s){const n=s?s.path():null,i=n?await e.pushNodeByPathToFrontend(n):null;if(t!==this._selectedNodeOnReset)return;let o=i?e.nodeForId(i):null;if(!o){const t=e.existingDocument();o=t?t.body||t.documentElement:null}o&&(this._setDefaultSelectedNode(o),this._lastSelectedNodeSelectedForTest())}).call(this,e,this._selectedNodeOnReset)}_lastSelectedNodeSelectedForTest(){}_setDefaultSelectedNode(e){if(!e||this._hasNonDefaultSelectedNode||this._pendingNodeReveal)return;const t=ElementsTreeOutline.forDOMModel(e.domModel());t&&(this.selectDOMNode(e),t.selectedTreeElement&&t.selectedTreeElement.expand())}searchCanceled(){delete this._searchConfig,this._hideSearchHighlights(),this._searchableView.updateSearchMatchesCount(0),delete this._currentSearchResultIndex,delete this._searchResults,SDK.DOMModel.DOMModel.cancelSearch()}performSearch(e,t,s){const n=e.query,i=n.trim();if(!i.length)return;this._searchConfig&&this._searchConfig.query===n?this._hideSearchHighlights():this.searchCanceled(),this._searchConfig=e;const o=Common.Settings.Settings.instance().moduleSetting("showUAShadowDOM").get(),r=SDK.SDKModel.TargetManager.instance().models(SDK.DOMModel.DOMModel),l=r.map(e=>e.performSearch(i,o));Promise.all(l).then(function(e){this._searchResults=[];for(let t=0;t<e.length;++t){const s=e[t];for(let e=0;e<s;++e)this._searchResults.push({domModel:r[t],index:e,node:void 0})}if(this._searchableView.updateSearchMatchesCount(this._searchResults.length),!this._searchResults.length)return;this._currentSearchResultIndex>=this._searchResults.length&&(this._currentSearchResultIndex=void 0);let n=this._currentSearchResultIndex;t&&(n=void 0===this._currentSearchResultIndex?s?-1:0:s?n-1:n+1,this._jumpToSearchResult(n))}.bind(this))}_domWordWrapSettingChanged(e){this._contentElement.classList.toggle("elements-wrap",e.data);for(const t of this._treeOutlines)t.setWordWrap(e.data)}switchToAndFocus(e){this._searchableView.cancelSearch(),UI.ViewManager.ViewManager.instance().showView("elements").then(()=>this.selectDOMNode(e,!0))}_jumpToSearchResult(e){this._searchResults&&(this._currentSearchResultIndex=(e+this._searchResults.length)%this._searchResults.length,this._highlightCurrentSearchResult())}jumpToNextSearchResult(){this._searchResults&&this.performSearch(this._searchConfig,!0)}jumpToPreviousSearchResult(){this._searchResults&&this.performSearch(this._searchConfig,!0,!0)}supportsCaseSensitiveSearch(){return!1}supportsRegexSearch(){return!1}_highlightCurrentSearchResult(){const e=this._currentSearchResultIndex,t=this._searchResults;if(!t)return;const s=t[e];if(this._searchableView.updateCurrentMatchIndex(e),null===s.node)return;if(void 0===s.node)return void s.domModel.searchResult(s.index).then(e=>{s.node=e,this._highlightCurrentSearchResult()});const n=this._treeElementForNode(s.node);if(s.node.scrollIntoView(),n){n.highlightSearchResults(this._searchConfig.query),n.reveal();const e=n.listItemElement.getElementsByClassName(UI.UIUtils.highlightedSearchResultClassName);e.length&&e[0].scrollIntoViewIfNeeded(!1)}}_hideSearchHighlights(){if(!this._searchResults||!this._searchResults.length||void 0===this._currentSearchResultIndex)return;const e=this._searchResults[this._currentSearchResultIndex];if(!e.node)return;const t=ElementsTreeOutline.forDOMModel(e.node.domModel()).findTreeElement(e.node);t&&t.hideSearchHighlights()}selectedDOMNode(){for(const e of this._treeOutlines)if(e.selectedDOMNode())return e.selectedDOMNode();return null}selectDOMNode(e,t){for(const s of this._treeOutlines){ElementsTreeOutline.forDOMModel(e.domModel())===s?s.selectDOMNode(e,t):s.selectDOMNode(null)}}_updateBreadcrumbIfNeeded(e){const t=e.data;this._breadcrumbs.updateNodes(t)}_crumbNodeSelected(e){const t=e.data;this.selectDOMNode(t,!0)}_treeOutlineForNode(e){return e?ElementsTreeOutline.forDOMModel(e.domModel()):null}_treeElementForNode(e){return this._treeOutlineForNode(e).findTreeElement(e)}_leaveUserAgentShadowDOM(e){let t;for(;(t=e.ancestorUserAgentShadowRoot())&&t.parentNode;)e=t.parentNode;return e}revealAndSelectNode(e,t,s){return this._omitDefaultSelection=!0,e=Common.Settings.Settings.instance().moduleSetting("showUAShadowDOM").get()?e:this._leaveUserAgentShadowDOM(e),s||e.highlightForTwoSeconds(),UI.ViewManager.ViewManager.instance().showView("elements",!1,!t).then(()=>{this.selectDOMNode(e,t),delete this._omitDefaultSelection,this._notFirstInspectElement||(ElementsPanel._firstInspectElementNodeNameForTest=e.nodeName(),ElementsPanel._firstInspectElementCompletedForTest(),Host.InspectorFrontendHost.InspectorFrontendHostInstance.inspectElementCompleted()),this._notFirstInspectElement=!0})}_showUAShadowDOMChanged(){for(const e of this._treeOutlines)e.update()}_setupTextSelectionHack(e){const t=n.bind(this),s=e=>{0===e.buttons&&n.call(this)};function n(){this._splitWidget.element.classList.remove("disable-resizer-for-elements-hack"),e.style.removeProperty("left"),e.style.removeProperty("padding-left"),e.style.removeProperty("width"),e.style.removeProperty("position"),e.window().removeEventListener("blur",t),e.window().removeEventListener("contextmenu",t,!0),e.window().removeEventListener("dragstart",t,!0),e.window().removeEventListener("mousemove",s,!0),e.window().removeEventListener("mouseup",t,!0),e.window().removeEventListener("visibilitychange",t)}e.addEventListener("mousedown",n=>{if(1!==n.which)return;this._splitWidget.element.classList.add("disable-resizer-for-elements-hack"),e.style.setProperty("height",e.offsetHeight+"px");e.style.setProperty("left","-1000000px"),e.style.setProperty("padding-left","1000000px"),e.style.setProperty("width","calc(100% + 1000000px)"),e.style.setProperty("position","fixed"),e.window().addEventListener("blur",t),e.window().addEventListener("contextmenu",t,!0),e.window().addEventListener("dragstart",t,!0),e.window().addEventListener("mousemove",s,!0),e.window().addEventListener("mouseup",t,!0),e.window().addEventListener("visibilitychange",t)},!0)}_updateSidebarPosition(){if(this.sidebarPaneView&&this.sidebarPaneView.tabbedPane().shouldHideOnDetach())return;let e;const t=Common.Settings.Settings.instance().moduleSetting("sidebarPosition").get();if(e="right"===t||"auto"===t&&self.UI.inspectorView.element.offsetWidth>680?_splitMode.Vertical:self.UI.inspectorView.element.offsetWidth>415?_splitMode.Horizontal:_splitMode.Slim,this.sidebarPaneView&&e===this._splitMode)return;this._splitMode=e;const s=self.Extensions.extensionServer.sidebarPanes();let n=null;this.sidebarPaneView&&(n=this.sidebarPaneView.tabbedPane().selectedTabId,this.sidebarPaneView.tabbedPane().detach(),this._splitWidget.uninstallResizer(this.sidebarPaneView.tabbedPane().headerElement())),this._splitWidget.setVertical(this._splitMode===_splitMode.Vertical),this.showToolbarPane(null,null);const i=new UI.Widget.VBox;i.element.classList.add("style-panes-wrapper"),this._stylesWidget.show(i.element),this._setupTextSelectionHack(i.element);const o=new UI.Widget.VBox;function r(e){e?this._metricsWidget.show(o.element,this._computedStyleWidget.element):this._metricsWidget.show(i.element)}o.element.classList.add("style-panes-wrapper"),this._computedStyleWidget.show(o.element),this.sidebarPaneView=UI.ViewManager.ViewManager.instance().createTabbedLocation(()=>UI.ViewManager.ViewManager.instance().showView("elements"));const l=this.sidebarPaneView.tabbedPane();this._splitMode!==_splitMode.Vertical&&this._splitWidget.installResizer(l.headerElement());const d=new UI.View.SimpleView(Common.UIString.UIString("Styles"));if(this.sidebarPaneView.appendView(d),e===_splitMode.Horizontal){d.element.classList.add("flex-auto");const e=new UI.SplitWidget.SplitWidget(!0,!0,"stylesPaneSplitViewState",215);e.show(d.element),e.setMainWidget(i),e.setSidebarWidget(o)}else{d.element.classList.add("flex-auto"),i.show(d.element);const e=new UI.View.SimpleView(Common.UIString.UIString("Computed"));e.element.classList.add("composite","fill"),o.show(e.element),l.addEventListener(UI.TabbedPane.Events.TabSelected,(function(e){const t=e.data.tabId;t===Common.UIString.UIString("Computed")?r.call(this,!0):t===Common.UIString.UIString("Styles")&&r.call(this,!1)}),this),this.sidebarPaneView.appendView(e)}this._stylesViewToReveal=d,r.call(this,this._splitMode===_splitMode.Horizontal),this.sidebarPaneView.appendApplicableItems("elements-sidebar");for(let e=0;e<s.length;++e)this._addExtensionSidebarPane(s[e]);n&&this.sidebarPaneView.tabbedPane().selectTab(n),this._splitWidget.setSidebarWidget(this.sidebarPaneView.tabbedPane())}_extensionSidebarPaneAdded(e){const t=e.data;this._addExtensionSidebarPane(t)}_addExtensionSidebarPane(e){e.panelName()===this.name&&this.sidebarPaneView.appendView(e)}}ElementsPanel._firstInspectElementCompletedForTest=function(){};export const _splitMode={Vertical:Symbol("Vertical"),Horizontal:Symbol("Horizontal"),Slim:Symbol("Slim")};export class ContextMenuProvider{appendApplicableItems(e,t,s){if(!(s instanceof SDK.RemoteObject.RemoteObject&&s.isNode()||s instanceof SDK.DOMModel.DOMNode||s instanceof SDK.DOMModel.DeferredDOMNode))return;if(ElementsPanel.instance().element.isAncestor(e.target))return;const n=Common.Revealer.reveal.bind(Common.Revealer.Revealer,s);t.revealSection().appendItem(Common.UIString.UIString("Reveal in Elements panel"),n)}}export class DOMNodeRevealer{reveal(e,t){const s=ElementsPanel.instance();return s._pendingNodeReveal=!0,new Promise((function(n,i){if(e instanceof SDK.DOMModel.DOMNode)o(e);else if(e instanceof SDK.DOMModel.DeferredDOMNode)e.resolve((function(e){if(!e){const e=ls`The deferred DOM Node could not be resolved into a valid node.`;return Common.Console.Console.instance().warn(e),void i(new Error(e))}o(e)}));else if(e instanceof SDK.RemoteObject.RemoteObject){const t=e.runtimeModel().target().model(SDK.DOMModel.DOMModel);t?t.pushObjectAsNodeToFrontend(e).then((function(e){if(!e){const e=ls`The remote object could not be resolved into a valid node.`;return Common.Console.Console.instance().warn(e),void i(new Error(e))}o(e)})):i(new Error("Could not resolve a node to reveal."))}else i(new Error("Can't reveal a non-node.")),s._pendingNodeReveal=!1;function o(o){s._pendingNodeReveal=!1;let r=o;for(;r.parentNode;)r=r.parentNode;const l=!(r instanceof SDK.DOMModel.DOMDocument);if(!(e instanceof SDK.DOMModel.DOMDocument)&&l){const e=ls`Node cannot be found in the current page.`;return Common.Console.Console.instance().warn(e),void i(new Error(e))}o?s.revealAndSelectNode(o,!t).then(n):i(new Error("Could not resolve node to reveal."))}}))}}export class CSSPropertyRevealer{reveal(e){return ElementsPanel.instance()._revealProperty(e)}}export class ElementsActionDelegate{handleAction(e,t){const s=self.UI.context.flavor(SDK.DOMModel.DOMNode);if(!s)return!0;const n=ElementsTreeOutline.forDOMModel(s.domModel());if(!n)return!0;switch(t){case"elements.hide-element":return n.toggleHideElement(s),!0;case"elements.edit-as-html":return n.toggleEditAsHTML(s),!0;case"elements.undo":return self.SDK.domModelUndoStack.undo(),ElementsPanel.instance()._stylesWidget.forceUpdate(),!0;case"elements.redo":return self.SDK.domModelUndoStack.redo(),ElementsPanel.instance()._stylesWidget.forceUpdate(),!0}return!1}}export class PseudoStateMarkerDecorator{decorate(e){return{color:"orange",title:Common.UIString.UIString("Element state: %s",":"+e.domModel().cssModel().pseudoState(e).join(", :"))}}}