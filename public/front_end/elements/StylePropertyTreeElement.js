import*as Bindings from"../bindings/bindings.js";import*as ColorPicker from"../color_picker/color_picker.js";import*as Common from"../common/common.js";import*as InlineEditor from"../inline_editor/inline_editor.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import{BezierPopoverIcon,ColorSwatchPopoverIcon,ShadowSwatchPopoverHelper}from"./ColorSwatchPopoverIcon.js";import{CSSPropertyPrompt,StylePropertiesSection,StylesSidebarPane,StylesSidebarPropertyRenderer}from"./StylesSidebarPane.js";export class StylePropertyTreeElement extends UI.TreeOutline.TreeElement{constructor(e,t,i,n,s,r,o){super("",n),this._style=i.ownerStyle,this._matchedStyles=t,this.property=i,this._inherited=s,this._overloaded=r,this.selectable=!1,this._parentPane=e,this.isShorthand=n,this._applyStyleThrottler=new Common.Throttler.Throttler(0),this._newProperty=o,this._newProperty&&(this.listItemElement.textContent=""),this._expandedDueToFilter=!1,this.valueElement=null,this.nameElement=null,this._expandElement=null,this._originalPropertyText="",this._hasBeenEditedIncrementally=!1,this._prompt=null,this._lastComputedValue=null,this._contextForTest}matchedStyles(){return this._matchedStyles}_editable(){return!(!this._style.styleSheetId||!this._style.range)}inherited(){return this._inherited}overloaded(){return this._overloaded}setOverloaded(e){e!==this._overloaded&&(this._overloaded=e,this._updateState())}get name(){return this.property.name}get value(){return this.property.value}_updateFilter(){const e=this._parentPane.filterRegex(),t=!!e&&(e.test(this.property.name)||e.test(this.property.value));this.listItemElement.classList.toggle("filter-match",t),this.onpopulate();let i=!1;for(let e=0;e<this.childCount();++e)i|=this.childAt(e)._updateFilter();return e?i&&!this.expanded?(this.expand(),this._expandedDueToFilter=!0):!i&&this.expanded&&this._expandedDueToFilter&&(this.collapse(),this._expandedDueToFilter=!1):(this._expandedDueToFilter&&this.collapse(),this._expandedDueToFilter=!1),t}_processColor(e){const t=Common.Color.Color.parse(e);if(!t)return createTextNode(e);if(!this._editable()){const e=InlineEditor.ColorSwatch.ColorSwatch.create();return e.setColor(t),e}const i=InlineEditor.ColorSwatch.ColorSwatch.create();return i.setColor(t),i.setFormat(Common.Settings.detectColorFormat(i.color())),this._addColorContrastInfo(i),i}_processVar(e){const t=this._matchedStyles.computeValue(this._style,e);if(!t)return createTextNode(e);const i=Common.Color.Color.parse(t);if(!i){const i=createElement("span");return i.textContent=e,i.title=t,i}if(!this._editable()){const n=InlineEditor.ColorSwatch.ColorSwatch.create();return n.setText(e,t),n.setColor(i),n}const n=InlineEditor.ColorSwatch.ColorSwatch.create();return n.setColor(i),n.setFormat(Common.Settings.detectColorFormat(n.color())),n.setText(e,t),this._addColorContrastInfo(n),n}async _addColorContrastInfo(e){const t=this._parentPane.swatchPopoverHelper(),i=new ColorSwatchPopoverIcon(this,t,e);if("color"!==this.property.name||!this._parentPane.cssModel()||!this.node())return;const n=this._parentPane.cssModel(),s=new ColorPicker.ContrastInfo.ContrastInfo(await n.backgroundColorsPromise(this.node().id));i.setContrastInfo(s)}renderedPropertyText(){return this.nameElement.textContent+": "+this.valueElement.textContent}_processBezier(e){if(!this._editable()||!UI.Geometry.CubicBezier.parse(e))return createTextNode(e);const t=this._parentPane.swatchPopoverHelper(),i=InlineEditor.ColorSwatch.BezierSwatch.create();return i.setBezierText(e),new BezierPopoverIcon(this,t,i),i}_processShadow(e,t){if(!this._editable())return createTextNode(e);let i;if(i="text-shadow"===t?InlineEditor.CSSShadowModel.CSSShadowModel.parseTextShadow(e):InlineEditor.CSSShadowModel.CSSShadowModel.parseBoxShadow(e),!i.length)return createTextNode(e);const n=createDocumentFragment(),s=this._parentPane.swatchPopoverHelper();for(let e=0;e<i.length;e++){0!==e&&n.appendChild(createTextNode(", "));const t=InlineEditor.ColorSwatch.CSSShadowSwatch.create();t.setCSSShadow(i[e]),new ShadowSwatchPopoverHelper(this,s,t);const r=t.colorSwatch();r&&new ColorSwatchPopoverIcon(this,s,r),n.appendChild(t)}return n}_processGrid(e,t){const i=TextUtils.TextUtils.Utils.splitStringByRegexes(e,[SDK.CSSMetadata.GridAreaRowRegex]);if(i.length<=1)return createTextNode(e);const n=Common.Settings.Settings.instance().moduleSetting("textEditorIndent").get(),s=createDocumentFragment();for(const e of i){const t=e.value.trim(),i=UI.Fragment.html`<br /><span class='styles-clipboard-only'>${n.repeat(2)}</span>${t}`;s.appendChild(i)}return s}_updateState(){if(!this.listItemElement)return;this._style.isPropertyImplicit(this.name)?this.listItemElement.classList.add("implicit"):this.listItemElement.classList.remove("implicit");!this.property.parsedOk&&StylesSidebarPane.ignoreErrorsForProperty(this.property)?this.listItemElement.classList.add("has-ignorable-error"):this.listItemElement.classList.remove("has-ignorable-error"),this.inherited()?this.listItemElement.classList.add("inherited"):this.listItemElement.classList.remove("inherited"),this.overloaded()?this.listItemElement.classList.add("overloaded"):this.listItemElement.classList.remove("overloaded"),this.property.disabled?this.listItemElement.classList.add("disabled"):this.listItemElement.classList.remove("disabled")}node(){return this._parentPane.node()}parentPane(){return this._parentPane}section(){return this.treeOutline&&this.treeOutline.section}_updatePane(){const e=this.section();e&&e.refreshUpdate(this)}async _toggleDisabled(e){if(!this._style.range)return;this._parentPane.setUserOperation(!0);const t=await this.property.setDisabled(e);this._parentPane.setUserOperation(!1),t&&(this._matchedStyles.resetActiveProperties(),this._updatePane(),this.styleTextAppliedForTest())}async onpopulate(){if(this.childCount()||!this.isShorthand)return;const e=this._style.longhandProperties(this.name);for(let t=0;t<e.length;++t){const i=e[t].name;let n=!1,s=!1;const r=this.section();r&&(n=r.isPropertyInherited(i),s=this._matchedStyles.propertyState(e[t])===SDK.CSSMatchedStyles.PropertyState.Overloaded);const o=new StylePropertyTreeElement(this._parentPane,this._matchedStyles,e[t],!1,n,s,!1);this.appendChild(o)}}onattach(){this.updateTitle(),this.listItemElement.addEventListener("mousedown",e=>{1===e.which&&(this._parentPane[ActiveSymbol]=this)},!1),this.listItemElement.addEventListener("mouseup",this._mouseUp.bind(this)),this.listItemElement.addEventListener("click",e=>{e.target.hasSelection()||e.target===this.listItemElement||e.consume(!0)})}onexpand(){this._updateExpandElement()}oncollapse(){this._updateExpandElement()}_updateExpandElement(){this._expandElement&&(this.expanded?this._expandElement.setIconType("smallicon-triangle-down"):this._expandElement.setIconType("smallicon-triangle-right"))}updateTitleIfComputedValueChanged(){const e=this._matchedStyles.computeValue(this.property.ownerStyle,this.property.value);e!==this._lastComputedValue&&(this._lastComputedValue=e,this._innerUpdateTitle())}updateTitle(){this._lastComputedValue=this._matchedStyles.computeValue(this.property.ownerStyle,this.property.value),this._innerUpdateTitle()}_innerUpdateTitle(){this._updateState(),this.isExpandable()?this._expandElement=UI.Icon.Icon.create("smallicon-triangle-right","expand-icon"):this._expandElement=null;const e=new StylesSidebarPropertyRenderer(this._style.parentRule,this.node(),this.name,this.value);if(this.property.parsedOk&&(e.setVarHandler(this._processVar.bind(this)),e.setColorHandler(this._processColor.bind(this)),e.setBezierHandler(this._processBezier.bind(this)),e.setShadowHandler(this._processShadow.bind(this)),e.setGridHandler(this._processGrid.bind(this))),this.listItemElement.removeChildren(),this.nameElement=e.renderName(),this.property.name.startsWith("--")&&(this.nameElement.title=this._matchedStyles.computeCSSVariable(this._style,this.property.name)||""),this.valueElement=e.renderValue(),!this.treeOutline)return;const t=Common.Settings.Settings.instance().moduleSetting("textEditorIndent").get();this.listItemElement.createChild("span","styles-clipboard-only").createTextChild(t+(this.property.disabled?"/* ":"")),this.listItemElement.appendChild(this.nameElement);const i=this.valueElement.firstElementChild&&"BR"===this.valueElement.firstElementChild.tagName?":":": ";if(this.listItemElement.createChild("span","styles-name-value-separator").textContent=i,this._expandElement&&this.listItemElement.appendChild(this._expandElement),this.listItemElement.appendChild(this.valueElement),this.listItemElement.createTextChild(";"),this.property.disabled&&this.listItemElement.createChild("span","styles-clipboard-only").createTextChild(" */"),this.property.parsedOk||(this.listItemElement.classList.add("not-parsed-ok"),this.listItemElement.insertBefore(StylesSidebarPane.createExclamationMark(this.property),this.listItemElement.firstChild)),this.property.activeInStyle()||this.listItemElement.classList.add("inactive"),this._updateFilter(),this.property.parsedOk&&this.section()&&this.parent.root){const e=createElement("input");e.className="enabled-button",e.type="checkbox",e.checked=!this.property.disabled,e.addEventListener("mousedown",e=>e.consume(),!1),e.addEventListener("click",e=>{this._toggleDisabled(!this.property.disabled),e.consume()},!1),UI.ARIAUtils.setAccessibleName(e,`${this.nameElement.textContent} ${this.valueElement.textContent}`),this.listItemElement.insertBefore(e,this.listItemElement.firstChild)}}_mouseUp(e){const t=this._parentPane[ActiveSymbol];this._parentPane[ActiveSymbol]=null,t===this&&(this.listItemElement.hasSelection()||UI.UIUtils.isBeingEdited(e.target)||(e.consume(!0),e.target!==this.listItemElement&&(UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e)&&this.section().navigable?this._navigateToSource(e.target):this.startEditing(e.target))))}_handleContextMenuEvent(e,t){const i=new UI.ContextMenu.ContextMenu(t);this.property.parsedOk&&this.section()&&this.parent.root&&i.defaultSection().appendCheckboxItem(ls`Toggle property and continue editing`,async()=>{this.editingCancelled(null,e);const i=this._parentPane.focusedSectionIndex(),n=this.treeOutline.rootElement().indexOfChild(this);await this._toggleDisabled(!this.property.disabled),t.consume(),this._parentPane.continueEditingElement(i,n)},!this.property.disabled),i.defaultSection().appendItem(ls`Reveal in Sources panel`,this._navigateToSource.bind(this)),i.show()}_navigateToSource(e,t){if(!this.section().navigable)return;const i=e===this.nameElement,n=Bindings.CSSWorkspaceBinding.CSSWorkspaceBinding.instance().propertyUILocation(this.property,i);n&&Common.Revealer.reveal(n,t)}startEditing(e){if(this.parent.isShorthand)return;if(this._expandElement&&e===this._expandElement)return;const t=this.section();if(t&&!t.editable)return;if(e&&(e=e.enclosingNodeOrSelfWithClass("webkit-css-property")||e.enclosingNodeOrSelfWithClass("value")),e||(e=this.nameElement),UI.UIUtils.isBeingEdited(e))return;const i=e===this.nameElement;var n;i||(SDK.CSSMetadata.cssMetadata().isGridAreaDefiningProperty(this.name)&&(this.valueElement.textContent=(n=this.value,TextUtils.TextUtils.Utils.splitStringByRegexes(n,[SDK.CSSMetadata.GridAreaRowRegex]).map(e=>e.value.trim()).join("\n"))),this.valueElement.textContent=function(e,t){const i=e.split(SDK.CSSMetadata.URLRegex);if(1===i.length)return e;const n=new RegExp(SDK.CSSMetadata.URLRegex);for(let e=1;e<i.length;e+=2){const s=n.exec(t);s&&(i[e]=s[0])}return i.join("")}(this.valueElement.textContent,this.value));const s={expanded:this.expanded,hasChildren:this.isExpandable(),isEditingName:i,originalProperty:this.property,previousContent:e.textContent};this._contextForTest=s,this.setExpandable(!1),e.parentElement&&e.parentElement.classList.add("child-editing"),e.textContent=e.textContent,this._originalPropertyText=this.property.propertyText,this._parentPane.setEditingStyle(!0,this),e.parentElement&&e.parentElement.scrollIntoViewIfNeeded(!1),this._prompt=new CSSPropertyPrompt(this,i),this._prompt.setAutocompletionTimeout(0),this._prompt.addEventListener(UI.TextPrompt.Events.TextChanged,e=>{this._applyFreeFlowStyleTextEdit(s)});const r=this._prompt.attachAndStartEditing(e,function(e,t){let i=t.target.textContent;e.isEditingName||(i=this.value||i),this._editingCommitted(i,e,"")}.bind(this,s));this._navigateToSource(e,!0),r.addEventListener("keydown",this._editingNameValueKeyDown.bind(this,s),!1),r.addEventListener("keypress",this._editingNameValueKeyPress.bind(this,s),!1),i&&(r.addEventListener("paste",function(e,t){const i=t.clipboardData.getData("Text");if(!i)return;const n=i.indexOf(":");if(n<0)return;const s=i.substring(0,n).trim(),r=i.substring(n+1).trim();t.preventDefault(),"originalName"in e||(e.originalName=this.nameElement.textContent,e.originalValue=this.valueElement.textContent),this.property.name=s,this.property.value=r,this.nameElement.textContent=s,this.valueElement.textContent=r,this.nameElement.normalize(),this.valueElement.normalize(),this._editingCommitted(t.target.textContent,e,"forward")}.bind(this,s),!1),r.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this,s),!1)),e.getComponentSelection().selectAllChildren(e)}_editingNameValueKeyDown(e,t){if(t.handled)return;let i;if(isEnterKey(t)&&!t.shiftKey)i="forward";else if(t.keyCode===UI.KeyboardShortcut.Keys.Esc.code||"Escape"===t.key)i="cancel";else if(!e.isEditingName&&this._newProperty&&t.keyCode===UI.KeyboardShortcut.Keys.Backspace.code){const e=t.target.getComponentSelection();e.isCollapsed&&!e.focusOffset&&(t.preventDefault(),i="backward")}else"Tab"===t.key&&(i=t.shiftKey?"backward":"forward",t.preventDefault());if(i){switch(i){case"cancel":this.editingCancelled(null,e);break;case"forward":case"backward":this._editingCommitted(t.target.textContent,e,i)}t.consume()}else;}_editingNameValueKeyPress(e,t){const i=String.fromCharCode(t.charCode);if(e.isEditingName?":"===i:";"===i&&function(e,t){let i="";for(let n=0;n<t;++n){const t=e[n];"\\"===t&&""!==i?++n:i||'"'!==t&&"'"!==t?i===t&&(i=""):i=t}return!i}(t.target.textContent,t.target.selectionLeftOffset()))return t.consume(!0),void this._editingCommitted(t.target.textContent,e,"forward")}async _applyFreeFlowStyleTextEdit(e){if(!this._prompt||!this._parentPane.node())return;const t=this._prompt.text();if(e.isEditingName&&t.includes(":"))return void this._editingCommitted(t,e,"forward");const i=this._prompt.textWithCurrentSuggestion();if(i.includes(";"))return;if(!!this._parentPane.node().pseudoType()){if("content"===this.name.toLowerCase())return;const e=i.trim().toLowerCase();if(e.startsWith("content:")||"display: none"===e)return}e.isEditingName?i.includes(":")?await this.applyStyleText(i,!1):this._hasBeenEditedIncrementally&&await this._applyOriginalStyle(e):await this.applyStyleText(`${this.nameElement.textContent}: ${i}`,!1)}kickFreeFlowStyleEditForTest(){const e=this._contextForTest;return this._applyFreeFlowStyleTextEdit(e)}editingEnded(e){this.setExpandable(e.hasChildren),e.expanded&&this.expand();const t=e.isEditingName?this.nameElement:this.valueElement;t.parentElement&&t.parentElement.classList.remove("child-editing"),this._parentPane.setEditingStyle(!1)}editingCancelled(e,t){this._removePrompt(),this._hasBeenEditedIncrementally?this._applyOriginalStyle(t):this._newProperty&&this.treeOutline.removeChild(this),this.updateTitle(),this.editingEnded(t)}async _applyOriginalStyle(e){await this.applyStyleText(this._originalPropertyText,!1,e.originalProperty)}_findSibling(e){let t=this;do{t="forward"===e?t.nextSibling:t.previousSibling}while(t&&t.inherited());return t}async _editingCommitted(e,t,i){this._removePrompt(),this.editingEnded(t);const n=t.isEditingName,s=n&&this.nameElement.textContent.includes(":")||!this.property;let r,o;const a="originalName"in t,l=a&&(this.nameElement.textContent!==t.originalName||this.valueElement.textContent!==t.originalValue),h=a&&n&&this.valueElement.textContent!==t.originalValue;let d=this;const p=n^"forward"===i,m=this._newProperty&&!e&&(p||n);("forward"===i&&(!n||h)||"backward"===i&&n)&&(d=d._findSibling(i),d||("forward"!==i||this._newProperty&&!e?"backward"===i&&(o=!0):r=!0));let c=d&&this.treeOutline?this.treeOutline.rootElement().indexOfChild(d):-1;const u=Platform.StringUtilities.isWhitespace(e),y=this._newProperty&&(h||p||!i&&!n||n&&u||s),_=this.section();if((e!==t.previousContent||l)&&!this._newProperty||y){let t;t=s?this.nameElement.textContent:u||this._newProperty&&Platform.StringUtilities.isWhitespace(this.valueElement.textContent)?"":n?e+": "+this.property.value:this.property.name+": "+e,await this.applyStyleText(t,!0),S.call(this,this._newProperty,!u,_)}else n?this.property.name=e:this.property.value=e,a||this._newProperty||this.updateTitle(),S.call(this,this._newProperty,!1,_);function S(e,t,s){if(i)if(d&&d.parent)d.startEditing(n?d.valueElement:d.nameElement);else{if(d&&!d.parent){const t=s.propertiesTreeOutline.rootElement();if("forward"===i&&u&&!n&&--c,c>=t.childCount()&&!this._newProperty)r=!0;else{const s=c>=0?t.childAt(c):null;if(s){let t=!n||h?s.nameElement:s.valueElement;return e&&u&&(t="forward"===i?s.nameElement:s.valueElement),void s.startEditing(t)}e||(o=!0)}}if(r){if(e&&!t&&n^"backward"===i)return;s.addNewBlankProperty().startEditing()}else if(m){d=this._findSibling(i);const e=d||"backward"===i?s:s.nextEditableSibling();e&&(e.style().parentRule?e.startEditingSelector():e.moveEditorFromSelector(i))}else o&&(s.style().parentRule?s.startEditingSelector():s.moveEditorFromSelector(i))}else this._parentPane.resetFocus()}}_removePrompt(){this._prompt&&(this._prompt.detach(),this._prompt=null)}styleTextAppliedForTest(){}applyStyleText(e,t,i){return this._applyStyleThrottler.schedule(this._innerApplyStyleText.bind(this,e,t,i))}async _innerApplyStyleText(e,t,i){if(!this.treeOutline||!this.property)return;if(!this._style.range)return;const n=this._hasBeenEditedIncrementally;if(!(e=e.replace(/[\xA0\t]/g," ").trim()).length&&t&&this._newProperty&&!n)return void this.parent.removeChild(this);const s=this._parentPane.node();this._parentPane.setUserOperation(!0),e.length&&!/;\s*$/.test(e)&&(e+=";");const r=!this._newProperty||n;let o=await this.property.setText(e,t,r);n&&t&&!o&&(t=!1,o=await this.property.setText(this._originalPropertyText,t,r)),this._parentPane.setUserOperation(!1);const a=i||this._style.propertyAt(this.property.index),l=this.property.index<this._style.allProperties().length;if(!o||!a&&l)return t&&(this._newProperty?this.treeOutline.removeChild(this):this.updateTitle()),void this.styleTextAppliedForTest();this._matchedStyles.resetActiveProperties(),this._hasBeenEditedIncrementally=!0,this.property=a,s===this.node()&&this._updatePane(),this.styleTextAppliedForTest()}ondblclick(){return!0}isEventWithinDisclosureTriangle(e){return e.target===this._expandElement}}export const ActiveSymbol=Symbol("ActiveSymbol");export let Context;