import*as Network from"../network/network.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";class AffectedResourcesView extends UI.TreeOutline.TreeElement{constructor(e,t){super(),this.toggleOnClick=!0,this._parent=e,this._resourceName=t,this._affectedResourcesCountElement=this.createAffectedResourcesCounter(),this._affectedResources=this.createAffectedResources(),this._affectedResourcesCount=0}createAffectedResourcesCounter(){const e=createElementWithClass("div","affected-resource-label");return this.listItemElement.appendChild(e),e}createAffectedResources(){const e=new UI.TreeOutline.TreeElement,t=createElementWithClass("table","affected-resource-list"),s=createElementWithClass("tr"),i=createElementWithClass("td","affected-resource-header");i.textContent="Name",s.appendChild(i);const o=createElementWithClass("td","affected-resource-header affected-resource-header-info");return o.textContent=" Context",s.appendChild(o),t.appendChild(s),e.listItemElement.appendChild(t),this.appendChild(e),t}getResourceName(e){return 1===e?this._resourceName.singular:this._resourceName.plural}updateAffectedResourceCount(e){this._affectedResourcesCount=e,this._affectedResourcesCountElement.textContent=`${e} ${this.getResourceName(e)}`,this.hidden=0===this._affectedResourcesCount,this._parent.updateAffectedResourceVisibility()}isEmpty(){return 0===this._affectedResourcesCount}clear(){this._affectedResources.textContent=""}}class AffectedCookiesView extends AffectedResourcesView{constructor(e,t){super(e,{singular:ls`cookie`,plural:ls`cookies`}),this._issue=t}_appendAffectedCookies(e){let t=0;for(const s of e)t++,this.appendAffectedCookie(s);this.updateAffectedResourceCount(t)}appendAffectedCookie(e){const t=createElementWithClass("tr","affected-resource-cookie"),s=createElementWithClass("td","");s.appendChild(UI.UIUtils.createTextButton(e.name,()=>{Network.NetworkPanel.NetworkPanel.revealAndFilter([{filterType:"cookie-domain",filterValue:e.domain},{filterType:"cookie-name",filterValue:e.name},{filterType:"cookie-path",filterValue:e.path}])},"link-style devtools-link"));const i=createElementWithClass("td","affected-resource-cookie-info");i.textContent=("."!==e.domain[0]?" ":"")+e.domain+e.path,t.appendChild(s),t.appendChild(i),this._affectedResources.appendChild(t)}update(){this.clear(),this._appendAffectedCookies(this._issue.cookies())}}class AffectedRequestsView extends AffectedResourcesView{constructor(e,t){super(e,{singular:ls`request`,plural:ls`requests`}),this._issue=t}_appendAffectedRequests(e){let t=0;for(const s of e)for(const e of self.SDK.networkLog.requestsForId(s.requestId))t++,this._appendNetworkRequest(e);this.updateAffectedResourceCount(t)}_appendNetworkRequest(e){const t=e.name().trimMiddle(100),s=createElementWithClass("td",""),i=issueTypeToNetworkHeaderMap.get(this._issue.getCategory())||Network.NetworkItemView.Tabs.Headers;s.appendChild(UI.UIUtils.createTextButton(t,()=>{Network.NetworkPanel.NetworkPanel.selectAndShowRequest(e,i)},"link-style devtools-link"));const o=createElementWithClass("tr","affected-resource-request");o.appendChild(s),this._affectedResources.appendChild(o)}update(){this.clear(),this._appendAffectedRequests(this._issue.requests())}}const issueTypeToNetworkHeaderMap=new Map([[SDK.Issue.IssueCategory.SameSiteCookie,Network.NetworkItemView.Tabs.Cookies],[SDK.Issue.IssueCategory.CrossOriginEmbedderPolicy,Network.NetworkItemView.Tabs.Headers]]);class IssueView extends UI.TreeOutline.TreeElement{constructor(e,t,s){super(),this._parent=e,this._issue=t,this._description=s,this.toggleOnClick=!0,this.listItemElement.classList.add("issue"),this.childrenListElement.classList.add("body"),this._affectedResources=this._createAffectedResources(),this._affectedCookiesView=new AffectedCookiesView(this,this._issue),this._affectedRequestsView=new AffectedRequestsView(this,this._issue)}onattach(){this._appendHeader(),this._createBody(),this.appendChild(this._affectedResources),this.appendAffectedResource(this._affectedCookiesView),this._affectedCookiesView.update(),this.appendAffectedResource(this._affectedRequestsView),this._affectedRequestsView.update(),this._createReadMoreLink(),this.updateAffectedResourceVisibility()}appendAffectedResource(e){this._affectedResources.appendChild(e)}_appendHeader(){const e=createElementWithClass("div","header"),t=UI.Icon.Icon.create("largeicon-breaking-change","icon");e.appendChild(t);const s=createElementWithClass("div","title");s.textContent=this._description.title,e.appendChild(s),this.listItemElement.appendChild(e)}updateAffectedResourceVisibility(){const e=!this._affectedCookiesView||this._affectedCookiesView.isEmpty(),t=!this._affectedRequestsView||this._affectedRequestsView.isEmpty(),s=e&&t;this._affectedResources.hidden=s}_createAffectedResources(){const e=new UI.TreeOutline.TreeElement;return e.setCollapsible(!1),e.setExpandable(!0),e.expand(),e.selectable=!1,e.listItemElement.classList.add("affected-resources-label"),e.listItemElement.textContent=ls`Affected Resources`,e.childrenListElement.classList.add("affected-resources"),e}_createBody(){const e=new UI.TreeOutline.TreeElement;e.setCollapsible(!1),e.selectable=!1,e.listItemElement.classList.add("kind-code-line");const t=createElementWithClass("span","issue-code");t.textContent=this._issue.code(),e.listItemElement.appendChild(t),this.appendChild(e);const s=new UI.TreeOutline.TreeElement;s.setCollapsible(!1),s.selectable=!1;const i=this._description.message();s.listItemElement.appendChild(i),this.appendChild(s)}_createReadMoreLink(){const e=UI.XLink.XLink.create(this._description.link,ls`Learn more: ${this._description.linkTitle}`,"link"),t=UI.Icon.Icon.create("largeicon-link","link-icon");e.prepend(t);const s=new UI.TreeOutline.TreeElement;s.setCollapsible(!1),s.listItemElement.classList.add("link-wrapper"),s.listItemElement.appendChild(e),this.appendChild(s)}update(){this._affectedCookiesView.update(),this._affectedRequestsView.update(),this.updateAffectedResourceVisibility()}toggle(e){e||void 0===e&&!this.expanded?this.expand():this.collapse()}}export class IssuesPaneImpl extends UI.Widget.VBox{constructor(){super(!0),this.registerRequiredCSS("issues/issuesPane.css"),this.contentElement.classList.add("issues-pane"),this._issueViews=new Map;const{toolbarContainer:e,updateToolbarIssuesCount:t}=this._createToolbars();this._issuesToolbarContainer=e,this._updateToolbarIssuesCount=t,this._issuesTree=new UI.TreeOutline.TreeOutlineInShadow,this._issuesTree.registerRequiredCSS("issues/issuesTree.css"),this._issuesTree.setShowSelectionOnKeyboardFocus(!0),this._issuesTree.contentElement.classList.add("issues"),this.contentElement.appendChild(this._issuesTree.element);const s=SDK.SDKModel.TargetManager.instance().mainTarget();if(this._model=null,s&&(this._model=s.model(SDK.IssuesModel.IssuesModel),this._model&&(this._model.addEventListener(SDK.IssuesModel.Events.AggregatedIssueUpdated,this._issueUpdated,this),this._model.addEventListener(SDK.IssuesModel.Events.FullUpdateRequired,this._fullUpdate,this),this._model.ensureEnabled())),this._model)for(const e of this._model.aggregatedIssues())this._updateIssueView(e);this._updateCounts(),this._reloadInfobar=null,this._infoBarDiv=null,this._showReloadInfobarIfNeeded()}_createToolbars(){const e=this.contentElement.createChild("div","issues-toolbar-container");new UI.Toolbar.Toolbar("issues-toolbar-left",e);const t=new UI.Toolbar.Toolbar("issues-toolbar-right",e);t.appendSeparator();const s=createElementWithClass("div","toolbar-warnings"),i=UI.Icon.Icon.create("largeicon-breaking-change");s.appendChild(i);const o=s.createChild("span","warnings-count-label"),a=new UI.Toolbar.ToolbarItem(s);t.appendToolbarItem(a);return{toolbarContainer:e,updateToolbarIssuesCount:e=>{o.textContent=""+e}}}_issueUpdated(e){const t=e.data;this._updateIssueView(t)}_updateIssueView(e){const t=e.getDescription();if(t){if(!this._issueViews.has(e.code())){const s=new IssueView(this,e,t);this._issueViews.set(e.code(),s),this._issuesTree.appendChild(s)}this._issueViews.get(e.code()).update(),this._updateCounts()}else console.warn("Could not find description for issue code:",e.code())}_fullUpdate(){this._hideReloadInfoBar();for(const e of this._issueViews.values())this._issuesTree.removeChild(e);this._issueViews.clear();for(const e of this._model.aggregatedIssues())this._updateIssueView(e);this._updateCounts()}_updateCounts(){this._updateToolbarIssuesCount(this._model.numberOfAggregatedIssues())}revealByCode(e){const t=this._issueViews.get(e);t&&t.reveal()}_showReloadInfobarIfNeeded(){if(!this._model||!this._model.reloadForAccurateInformationRequired())return;const e=new UI.Infobar.Infobar(UI.Infobar.Type.Warning,ls`Some issues might be missing or incomplete, reload the inspected page to get full information`,[{text:ls`Reload page`,highlight:!1,delegate:function(){const e=SDK.SDKModel.TargetManager.instance().mainTarget();if(e){const t=e.model(SDK.ResourceTreeModel.ResourceTreeModel);t&&t.reloadPage()}},dismiss:!0}]);this._reloadInfobar=e,this._attachReloadInfoBar(e)}_attachReloadInfoBar(e){this._infoBarDiv||(this._infoBarDiv=createElementWithClass("div","flex-none"),this.contentElement.insertBefore(this._infoBarDiv,this._issuesToolbarContainer.nextSibling)),this._infoBarDiv.appendChild(e.element),e.setParentView(this),this.doResize()}_hideReloadInfoBar(){this._reloadInfobar&&(this._reloadInfobar.dispose(),this._reloadInfobar=null)}}