import{FormattedContentBuilder}from"./FormattedContentBuilder.js";import{createTokenizer}from"./FormatterWorker.js";export class CSSFormatter{constructor(e){this._builder=e}format(e,t,s,i){this._lineEndings=t,this._fromOffset=s,this._toOffset=i,this._lastLine=-1,this._state={};const r=createTokenizer("text/css"),a=this._builder.setEnforceSpaceBetweenWords(!1);r(e.substring(this._fromOffset,this._toOffset),this._tokenCallback.bind(this)),this._builder.setEnforceSpaceBetweenWords(a)}_tokenCallback(e,t,s){s+=this._fromOffset;const i=this._lineEndings.lowerBound(s);i!==this._lastLine&&(this._state.eatWhitespace=!0),/^property/.test(t)&&!this._state.inPropertyValue&&(this._state.seenProperty=!0),this._lastLine=i;if(/^\s+$/.test(e))this._state.eatWhitespace||this._builder.addSoftSpace();else if(this._state.eatWhitespace=!1,"\n"!==e){if("}"!==e&&(this._state.afterClosingBrace&&this._builder.addNewLine(!0),this._state.afterClosingBrace=!1),"}"===e)this._state.inPropertyValue&&this._builder.addNewLine(),this._builder.decreaseNestingLevel(),this._state.afterClosingBrace=!0,this._state.inPropertyValue=!1;else{if(":"===e&&!this._state.inPropertyValue&&this._state.seenProperty)return this._builder.addToken(e,s),this._builder.addSoftSpace(),this._state.eatWhitespace=!0,this._state.inPropertyValue=!0,void(this._state.seenProperty=!1);if("{"===e)return this._builder.addSoftSpace(),this._builder.addToken(e,s),this._builder.addNewLine(),void this._builder.increaseNestingLevel()}this._builder.addToken(e,s),"comment"!==t||this._state.inPropertyValue||this._state.seenProperty||this._builder.addNewLine(),";"===e&&this._state.inPropertyValue?(this._state.inPropertyValue=!1,this._builder.addNewLine()):"}"===e&&this._builder.addNewLine()}}}