import{AcornTokenizer}from"./AcornTokenizer.js";import{ESTreeWalker}from"./ESTreeWalker.js";import{FormattedContentBuilder}from"./FormattedContentBuilder.js";export class JavaScriptFormatter{constructor(t){this._builder=t}format(t,e,n,r){this._fromOffset=n,this._toOffset=r,this._content=t.substring(this._fromOffset,this._toOffset),this._lastLineNumber=0,this._tokenizer=new AcornTokenizer(this._content);const i=acorn.parse(this._content,{ranges:!1,preserveParens:!0,allowImportExportEverywhere:!0,ecmaVersion:2020});new ESTreeWalker(this._beforeVisit.bind(this),this._afterVisit.bind(this)).walk(i)}_push(t,e){for(let n=0;n<e.length;++n)"s"===e[n]?this._builder.addSoftSpace():"S"===e[n]?this._builder.addHardSpace():"n"===e[n]?this._builder.addNewLine():">"===e[n]?this._builder.increaseNestingLevel():"<"===e[n]?this._builder.decreaseNestingLevel():"t"===e[n]&&(this._tokenizer.tokenLineStart()-this._lastLineNumber>1&&this._builder.addNewLine(!0),this._lastLineNumber=this._tokenizer.tokenLineEnd(),this._builder.addToken(this._content.substring(t.start,t.end),this._fromOffset+t.start))}_beforeVisit(t){if(t.parent)for(;this._tokenizer.peekToken()&&this._tokenizer.peekToken().start<t.start;){const e=this._tokenizer.nextToken(),n=this._formatToken(t.parent,e);this._push(e,n)}}_afterVisit(t){for(;this._tokenizer.peekToken()&&this._tokenizer.peekToken().start<t.end;){const e=this._tokenizer.nextToken(),n=this._formatToken(t,e);this._push(e,n)}this._push(null,this._finishNode(t))}_inForLoopHeader(t){const e=t.parent;return!!e&&("ForStatement"===e.type?t===e.init||t===e.test||t===e.update:("ForInStatement"===e.type||"ForOfStatement"===e.type)&&(t===e.left||e.right))}_formatToken(t,e){const n=AcornTokenizer;if(n.lineComment(e))return"tn";if(n.blockComment(e))return"tn";if("ContinueStatement"===t.type||"BreakStatement"===t.type)return t.label&&n.keyword(e)?"ts":"t";if("Identifier"===t.type)return"t";if("ReturnStatement"===t.type)return n.punctuator(e,";")?"t":t.argument?"ts":"t";if("AwaitExpression"===t.type)return n.punctuator(e,";")?"t":t.argument?"ts":"t";if("Property"===t.type)return n.punctuator(e,":")?"ts":"t";if("ArrayExpression"===t.type)return n.punctuator(e,",")?"ts":"t";if("LabeledStatement"===t.type){if(n.punctuator(e,":"))return"ts"}else if("LogicalExpression"===t.type||"AssignmentExpression"===t.type||"BinaryExpression"===t.type){if(n.punctuator(e)&&!n.punctuator(e,"()"))return"sts"}else if("ConditionalExpression"===t.type){if(n.punctuator(e,"?:"))return"sts"}else if("VariableDeclarator"===t.type){if(n.punctuator(e,"="))return"sts"}else if("ObjectPattern"===t.type){if(t.parent&&"VariableDeclarator"===t.parent.type&&n.punctuator(e,"{"))return"st";if(n.punctuator(e,","))return"ts"}else if("FunctionDeclaration"===t.type){if(n.punctuator(e,",)"))return"ts"}else if("FunctionExpression"===t.type){if(n.punctuator(e,",)"))return"ts";if(n.keyword(e,"function"))return t.id?"ts":"t"}else if("WithStatement"===t.type){if(n.punctuator(e,")"))return t.body&&"BlockStatement"===t.body.type?"ts":"tn>"}else if("SwitchStatement"===t.type){if(n.punctuator(e,"{"))return"tn>";if(n.punctuator(e,"}"))return"n<tn";if(n.punctuator(e,")"))return"ts"}else if("SwitchCase"===t.type){if(n.keyword(e,"case"))return"n<ts";if(n.keyword(e,"default"))return"n<t";if(n.punctuator(e,":"))return"tn>"}else if("VariableDeclaration"===t.type){if(n.punctuator(e,",")){let e=!0;const n=t.declarations;for(let t=0;t<n.length;++t)e=e&&!!n[t].init;return!this._inForLoopHeader(t)&&e?"nSSts":"ts"}}else if("BlockStatement"===t.type){if(n.punctuator(e,"{"))return t.body.length?"tn>":"t";if(n.punctuator(e,"}"))return t.body.length?"n<t":"t"}else if("CatchClause"===t.type){if(n.punctuator(e,")"))return"ts"}else if("ObjectExpression"===t.type){if(!t.properties.length)return"t";if(n.punctuator(e,"{"))return"tn>";if(n.punctuator(e,"}"))return"n<t";if(n.punctuator(e,","))return"tn"}else if("IfStatement"===t.type){if(n.punctuator(e,")"))return t.consequent&&"BlockStatement"===t.consequent.type?"ts":"tn>";if(n.keyword(e,"else")){const e=t.consequent&&"BlockStatement"===t.consequent.type?"st":"n<t";let n="n>";return!t.alternate||"BlockStatement"!==t.alternate.type&&"IfStatement"!==t.alternate.type||(n="s"),e+n}}else if("CallExpression"===t.type){if(n.punctuator(e,","))return"ts"}else{if("SequenceExpression"===t.type&&n.punctuator(e,","))return t.parent&&"SwitchCase"===t.parent.type?"ts":"tn";if("ForStatement"===t.type||"ForOfStatement"===t.type||"ForInStatement"===t.type){if(n.punctuator(e,";"))return"ts";if(n.keyword(e,"in")||n.identifier(e,"of"))return"sts";if(n.punctuator(e,")"))return t.body&&"BlockStatement"===t.body.type?"ts":"tn>"}else if("WhileStatement"===t.type){if(n.punctuator(e,")"))return t.body&&"BlockStatement"===t.body.type?"ts":"tn>"}else if("DoWhileStatement"===t.type){const r=t.body&&"BlockStatement"===t.body.type;if(n.keyword(e,"do"))return r?"ts":"tn>";if(n.keyword(e,"while"))return r?"sts":"n<ts"}else{if("ClassBody"===t.type)return n.punctuator(e,"{")?"stn>":n.punctuator(e,"}")?"<ntn":"t";if("YieldExpression"===t.type)return"t";if("Super"===t.type)return"t";if("ImportExpression"===t.type)return"t";if("ExportAllDeclaration"===t.type)return n.punctuator(e,"*")?"sts":"t";if("ExportNamedDeclaration"===t.type||"ImportDeclaration"===t.type)return n.punctuator(e,"{")?"st":n.punctuator(e,",")?"ts":n.punctuator(e,"}")?t.source?"ts":"t":n.punctuator(e,"*")?"sts":"t"}}return n.keyword(e)&&!n.keyword(e,"this")?"ts":"t"}_finishNode(t){if("WithStatement"===t.type){if(t.body&&"BlockStatement"!==t.body.type)return"n<"}else if("VariableDeclaration"===t.type){if(!this._inForLoopHeader(t))return"n"}else if("ForStatement"===t.type||"ForOfStatement"===t.type||"ForInStatement"===t.type){if(t.body&&"BlockStatement"!==t.body.type)return"n<"}else{if("BlockStatement"===t.type)return t.parent&&"IfStatement"===t.parent.type&&t.parent.alternate&&t.parent.consequent===t||t.parent&&"FunctionExpression"===t.parent.type&&t.parent.parent&&"Property"===t.parent.parent.type||t.parent&&"FunctionExpression"===t.parent.type&&t.parent.parent&&"VariableDeclarator"===t.parent.parent.type||t.parent&&"FunctionExpression"===t.parent.type&&t.parent.parent&&"CallExpression"===t.parent.parent.type||t.parent&&"DoWhileStatement"===t.parent.type?"":t.parent&&"TryStatement"===t.parent.type&&t.parent.block===t||t.parent&&"CatchClause"===t.parent.type&&t.parent.parent.finalizer?"s":"n";if("WhileStatement"===t.type){if(t.body&&"BlockStatement"!==t.body.type)return"n<"}else if("IfStatement"===t.type){if(t.alternate){if("BlockStatement"!==t.alternate.type&&"IfStatement"!==t.alternate.type)return"<"}else if(t.consequent&&"BlockStatement"!==t.consequent.type)return"<"}else{if("BreakStatement"===t.type||"ContinueStatement"===t.type||"ThrowStatement"===t.type||"ReturnStatement"===t.type||"ExpressionStatement"===t.type)return"n";if("ImportDeclaration"===t.type||"ExportAllDeclaration"===t.type||"ExportDefaultDeclaration"===t.type||"ExportNamedDeclaration"===t.type)return"n"}}return""}}